<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Trading Form</title>


    <link rel="stylesheet" href="{{ url_for('static', filename='code.css') }}">

    {#
    <link rel="stylesheet" href="../static/code.css">#}


    <style>
        /* body {0
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f9f9f9;
        } */

        .form-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .field {
            position: relative;
            display: inline-block;
        }

        .field input,
        .field select,
        .field .radio-box {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 15px;
            width: 160px;
            box-sizing: border-box;
            background: #f9f9f9;
        }

        .field {
            margin: 7px;
            transition: margin-bottom 0.2s ease;
        }

        .floating-label {
            position: absolute;
            top: -7px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 13px;
            background: #fff;
            padding: 0 6px;
            color: #555;
            line-height: 1;
        }

        .radio-box {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 42px;
        }

        .field input:focus,
        .field select:focus,
        .field .radio-box:focus-within {
            border-color: #1976d2;
            outline: none;
        }

        .order-type {
            display: flex;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }

        .order-type label {
            padding: 8px 16px;
            cursor: pointer;
            border-right: 1px solid #ccc;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .order-type label:last-child {
            border-right: none;
        }

        .order-type input[type="radio"],
        .order-type input[type="checkbox"] {
            display: none;
        }

        .order-type input:checked+span {
            color: #0066ff;
            font-weight: bold;
        }

        .days {
            display: flex;
            gap: 1px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        .days button:last-child {
            border-right: none;
        }

        .days button {
            border: none;
            border-right: 1px solid #ccc;
            background: #f0f3f8;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            color: #333;
            font-weight: 500;
        }

        .days button.active {
            background: #0066ff;
            color: white;
        }

        .legs-container,
        .profile_container {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-top: 20px;
            position: relative;
            width: fit-content;
        }

        header,
        main,
        aside,
        footer {
            border: 2px solid rgb(167, 175, 187);
            background-color: #b6aaff;
        }

        nav {
            border-radius: 50px;
            background-color: #b6aaff;
        }



        #head_notice {
            width: 100%;
            background-color: #edecf3;
            margin-bottom: -2px;
        }


        header {
            background: linear-gradient(90deg, #007bff, #00c6ff);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            font-family: Arial, sans-serif;
        }

        .header-left {
            font-size: 1.4em;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .header-right {
            display: flex;
            gap: 20px;
            font-size: 1em;
        }

        .header-item span {
            font-weight: bold;
            color: #f0f0f0;
        }

        .crypto-item {
            font-family: Arial;
            font-size: 14px;
        }

        .up {
            color: green;
            margin-left: 4px;
        }

        .down {
            color: #ff5555;
            margin-left: 4px;
        }


        /* --- MODAL CSS STYLES --- */

        /* The hidden background overlay */
        .modal-overlay {
            /* 1. Position:fixed ensures it ignores scrolling and other containers */
            position: fixed;

            /* 2. Top/Left/Right/Bottom:0 ensures it covers the ENTIRE viewport */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;

            /* 3. High z-index ensures it sits above all other elements (divs, aside, etc.) */
            z-index: 9999;
            /* Use a very high number */

            /* 4. Centering the content */
            display: flex;
            justify-content: center;
            /* Horizontal Center */
            align-items: center;
            /* Vertical Center */

            /* background-color: rgba(0, 0, 0, 0.7); */
            /* Dark semi-transparent overlay */

            /* Initially hidden - will be changed to 'flex' by JS */
            display: none;
        }

        /* The content wrapper (where the popup.html content goes) */
        .modal-content-wrapper {
            /* Ensure no background/padding interferes with the injected content's size/style */
            background-color: rgba(0, 0, 0, 0.7);
            /* Optional: Add a slight margin to keep content away from the screen edge */
            margin: 20px;
            /* Optional: Ensure the wrapper itself does not stretch unnecessarily */
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            /* If content is too long, allow scrolling inside the modal */
        }

        /* IMPORTANT: If your body/html has a transform or perspective property, fixed positioning may fail. 
   If so, you might need to use position: absolute on the overlay and ensure html/body height is 100%. */



        /* settings wrapper */
        .settings-wrapper {
            position: absolute;
            top: 82px;
            right: 10px;
        }

        /* settings icon */
        .settings {
            cursor: pointer;
            font-size: 18px;
        }

        /* dropdown */
        .dropdown {
            display: none;
            position: absolute;
            top: 25px;
            right: 0;
            background: #05e1e8;
            border: 1px solid #444;
            border-radius: 4px;
            width: 150px;
            z-index: 10;
        }

        /* show dropdown on hover */
        .settings-wrapper:hover .dropdown {
            display: block;
        }

        .dropdown div {
            padding: 10px;
            cursor: pointer;
            color: white;
        }

        .dropdown div:hover {
            background: #333;
        }
    </style>
    <style>
        /* ================= SELECTION ================= */
        .template .selection {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            width: max-content;
            gap: 25px;
            background: #f4f6f8;
        }

        .template .card {
            padding: 25px 35px;
            border-radius: 16px;
            background: linear-gradient(135deg, #0066ff, #5c9bb0, #2c5364);
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: transform .3s;
            box-shadow: 0 10px 25px rgba(0, 0, 0, .25);
        }

        .template .card:hover {
            transform: scale(1.1);
        }

        /* ================= STRATEGY VIEW ================= */
        .template .strategy {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: linear-gradient(270deg, #0f2027, #203a43, #2c5364);
            background-size: 600% 600%;
            animation: bgMove 12s ease infinite;
        }

        @keyframes bgMove {
            0% {
                background-position: 0% 50%
            }

            50% {
                background-position: 100% 50%
            }

            100% {
                background-position: 0% 50%
            }
        }

        .template .top {
            width: 95%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .template .heading {
            font-size: 28px;
        }

        .template button {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        /* ================= LOADER ================= */
        .template .loader {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, .3);
            border-top: 6px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 40px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        /* ================= TABLE ================= */
        .template table {
            width: 95%;
            background: white;
            border-collapse: collapse;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        .template th,
        td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
            font-size: 14px;
        }

        th {
            background: #f2f2f2;
        }

        .template .buy {
            color: green;
            font-weight: bold;
        }

        .template .sell {
            color: red;
            font-weight: bold;
        }

        /* ================= HISTORY ================= */
        .template .history {
            width: 95%;
            background: white;
            margin-top: 20px;
            border-radius: 10px;
            padding: 10px;
        }

        .template .history h3 {
            margin: 0 0 10px;
        }

        .template .history ul {
            list-style: none;
            padding: 0;
            max-height: 160px;
            overflow-y: auto;
        }

        .template .history li {
            padding: 6px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        .template .hidden {
            display: none;
        }


        /* ===== STRONG POSITIVE ===== */
        .template .row-strong-pos {
            background: linear-gradient(90deg, #e6ffe6, #b3ffb3);
            border: 2px solid #00c853;
            animation: pulseGreen 1.5s infinite;
        }

        /* ===== STRONG NEGATIVE ===== */
        .template .row-strong-neg {
            background: linear-gradient(90deg, #ffe6e6, #ffb3b3);
            border: 2px solid #d50000;
            animation: pulseRed 1.5s infinite;
        }

        @keyframes pulseGreen {
            0% {
                box-shadow: 0 0 5px #00c853;
            }

            50% {
                box-shadow: 0 0 15px #00c853;
            }

            100% {
                box-shadow: 0 0 5px #00c853;
            }
        }

        @keyframes pulseRed {
            0% {
                box-shadow: 0 0 5px #d50000;
            }

            50% {
                box-shadow: 0 0 15px #d50000;
            }

            100% {
                box-shadow: 0 0 5px #d50000;
            }
        }



        .template .settings {
            border: 1px solid #333;
            padding: 12px;
            margin-top: 12px;
            background: #111;
            color: #fff;
        }

        .template .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .template .settings-header button {
            background: none;
            border: none;
            color: red;
            font-size: 18px;
            cursor: pointer;
        }

        .template .settings-btn {
            margin-left: 10px;
            cursor: pointer;
        }

        .template .settings-btn .active {
            border: 1px solid #00ff9c;
            background: #002b1f;
            color: #00ff9c;
            box-shadow: 0 0 6px rgba(0, 255, 156, 0.6);
        }

        .active {
            border: 1px solid #00ff9c;
            background: #002b1f;
            color: #00ff9c;
            box-shadow: 0 0 6px rgba(0, 255, 156, 0.6);
        }


        .template .opacity {
            opacity: 0;
        }

        .template .start-btn {
            margin-top: 12px;
            padding: 8px 14px;
            background: #0057ff;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .template .start-btn:hover {
            background: #003bbd;
        }




        #my_legs {
            display: flex;
            gap: 5px;
        }


        #my_legs .leg-box {
            border: 1px solid #d1d5db;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            background: #fff;

            min-width: max-content;
            /* üîπ ‡¶è‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ */
            max-width: 20%;
            /* üîπ ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶ö‡¶ì‡ßú‡¶æ ‡¶π‡¶¨‡ßá ‡¶®‡¶æ */

            height: max-content;
        }

        #my_legs .leg-top {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }


        #my_legs .side-buy {
            color: #16a34a;
            font-weight: bold;
        }

        #my_legs .side-sell {
            color: #dc2626;
            font-weight: bold;
        }

        /* #my_legs .leg-meta {
            font-size: 13px;
            margin-top: 6px;
            color: #374151;
        } */

        #my_legs .leg-meta {
            font-size: 13px;
            margin-top: 4px;
            /* 6px ‚Üí 4px */
            color: #374151;
        }

        #my_legs .leg-grid {
            display: grid;
            grid-template-columns: max-content max-content max-content;
            gap: 40px;
            font-size: 13px;
            margin-top: 8px;
        }

        /* #my_legs .leg-grid {
            grid-template-columns: max-content max-content max-content;
            gap: 40px;
        } */


        #my_legs .adv-section {
            /* margin-top: 10px;
            padding: 8px;
            background: #f9fafb;
            border-radius: 8px;
            display: none;
            font-size: 12px; */

            margin-top: 8px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
        }

        #my_legs .adv-section pre {
            margin-top: 6px;
            padding: 8px;
            font-size: 12px;
            background: #f9fafb;
            border-radius: 6px;
            max-height: 160px;
            /* üî• too tall ‡¶®‡¶æ ‡¶π‡¶¨‡ßá */
            overflow: auto;
        }


        #my_legs .adv-title {
            /* font-weight: bold;
            margin-top: 6px;
            color: #111827; */
            margin-top: 8px;
            margin-bottom: 2px;
            font-weight: 600;
            font-size: 13px;
            color: #111827;
        }

        #my_legs .adv-row {
            /* display: flex;
            justify-content: space-between;
            color: #374151; */

            display: grid;
            grid-template-columns: 120px auto;
            /* üî• key fix */
            gap: 8px;
            font-size: 13px;
            line-height: 1.4;
            padding: 2px 0;
        }

        #my_legs .adv-row span:first-child {
            color: #6b7280;
        }

        #my_legs .adv-row span:last-child {
            color: #111827;
            text-align: left;
            /* üî• right align ‡¶¨‡¶®‡ßç‡¶ß */
        }

        #my_legs .leg-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }

        #my_legs .btn {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            border: none;
        }

        #my_legs .btn-adv {
            background: #e5e7eb;
        }

        #my_legs .btn-remove {
            background: #ef4444;
            color: #fff;
        }


        /* .error-msg {
            color: red;
            font-size: 12px;
            margin-top: 4px;
            position: absolute;
        }

        .error {
            border-color: red !important;
        } */


        .input-wrap {
            position: relative;
            /* üî• anchor */
        }

        .error-msg {
            position: absolute;
            /* left: 0; */
            /* top: 100%; */
            /* ‡¶è‡¶ñ‡¶® input-wrap ‡¶è‡¶∞ 100% */
            margin-top: 4px;

            color: red;
            font-size: 12px;
            min-height: 14px;

            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .error-msg.show {
            opacity: 1;
            transform: translateY(0);
        }

        .error {
            border-color: red !important;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>


    <!-- <button id="openPopupButton">Open Close Position Modal</button> -->

    <div id="closePositionModal" class="modal-overlay">
        <div class="modal-content-wrapper" id="modalContentArea">
        </div>
    </div>

    <!-- //////////////////////////////////////////////////// -->



    <!-- <header>HEADER</header> -->
    <header>
        <div class="header-left">
            üöÄ Trading Dashboard
        </div>
        <div class="header-right">
            <div class="header-item">üÜî ID: <span id="user_id">--</span></div>
            <div class="header-item">üë§ Username: <span id="username">--</span></div>
            <div class="header-item">üìß Email: <span id="email">--</span></div>
        </div>
    </header>


    <div id="head_notice">

        <marquee behavior="scroll" direction="left" scrollamount="5" id="crypto-marquee" style="margin-top: 2px;">
            <span class="crypto-item">
                BTC
                <span class="up">
                    +0.797%
                </span>
                <span class="crypto-price">123102.90</span>
            </span>

            <span class="crypto-item">
                ETH
                <span class="up">
                    +1.358%
                </span>
                <span class="crypto-price">4547.18</span>
            </span>

            <span class="crypto-item">
                SOL
                <span class="up">
                    +1.38%
                </span>
                <span class="crypto-price">232.16</span>
            </span>

            <span class="crypto-item">
                ADA
                <span class="up">
                    +2.456%
                </span>
                <span class="crypto-price">0.86</span>
            </span>

            <span class="crypto-item">
                XRP
                <span class="up">
                    +1.058%
                </span>
                <span class="crypto-price">3.02</span>
            </span>

            <span class="crypto-item">
                BTC
                <span class="up">
                    +0.797%
                </span>
                <span class="crypto-price">123102.90</span>
            </span>

            <span class="crypto-item">
                ETH
                <span class="up">
                    +1.358%
                </span>
                <span class="crypto-price">4547.18</span>
            </span>

            <span class="crypto-item">
                SOL
                <span class="up">
                    +1.38%
                </span>
                <span class="crypto-price">232.16</span>
            </span>

            <span class="crypto-item">
                ADA
                <span class="up">
                    +2.456%
                </span>
                <span class="crypto-price">0.86</span>
            </span>

            <span class="crypto-item">
                XRP
                <span class="up">
                    +1.058%
                </span>
                <span class="crypto-price">3.02</span>
            </span>
        </marquee>
        <div class="settings-wrapper">
            <div class="settings">‚öôÔ∏è</div>

            <div class="dropdown">
                <div onclick="showPrice()">Show Price</div>
                <div onclick="showFunding()">Show Funding Rate</div>
            </div>
        </div>

    </div>

    <div class="container">



        <aside class="left">

            <h1>Live Monitor Demo</h1>


            <div class="small-box">
                <div class="card">
                    <div class="counter" id="counter">0</div><br>
                    <div> Last update:<span class="time" id="time"></span></div>
                    <div> IP:<span class="ip" id="ip"></span></div>
                    <div>Status:<span class="status" id="status"> </span></div>
                    <div>Connection:<span class="conn" id="conn"> </span></div>
                </div>
            </div>
            <div class="small-box">
                <div class="small-box">
                    <div class="card">
                        <div>
                            <h2 style="color: rgb(88, 91, 91);">Delta Exchange</h2>
                            <h3>Balance</h3>
                            <div>USD : <span id="usd"></span> INR : <span id="inr"></span></div>
                        </div>
                        <button id="reloadBalanceBtn" class="reloadBtn">
                            <img src="https://imgs.search.brave.com/EUqLJgAYrZo1Jc1JpbGyNe75MiYVXcnHaHXdBMcnV3M/rs:fit:0:180:1:0/g:ce/aHR0cHM6Ly9jZG4u/aWNvbnNjb3V0LmNv/bS9pY29uL3ByZW1p/dW0vcG5nLTI1Ni10/aHVtYi9yZWZyZXNo/LWljb24tc3ZnLWRv/d25sb2FkLXBuZy00/NTk4NTExLnBuZz9m/PXdlYnAmdz0xMjg"
                                alt="Reload">
                        </button>
                    </div>
                </div>


            </div>



            <div class="small-box">
                <div class="small-box">
                    <div class="card">
                        <div>
                            <h2 style="color: rgb(88, 91, 91);">Coin DCX</h2>
                            <!-- <h3>Balance</h3> -->
                            <div>Fund :<span id="Dcx_fund"></span></div><br>
                            <div>USD : <span id="usd2"></span> INR : <span id="inr2"></span></div>
                        </div>
                        <button id="reloadBalanceBtn2" class="reloadBtn">
                            <img src="https://imgs.search.brave.com/EUqLJgAYrZo1Jc1JpbGyNe75MiYVXcnHaHXdBMcnV3M/rs:fit:0:180:1:0/g:ce/aHR0cHM6Ly9jZG4u/aWNvbnNjb3V0LmNv/bS9pY29uL3ByZW1p/dW0vcG5nLTI1Ni10/aHVtYi9yZWZyZXNo/LWljb24tc3ZnLWRv/d25sb2FkLXBuZy00/NTk4NTExLnBuZz9m/PXdlYnAmdz0xMjg"
                                alt="Reload">
                        </button>
                    </div>
                </div>


            </div>
            <div class="small-box"
                style="font-size: 50px; justify-content: center; text-align: center; flex-direction: column;">+</div>
            <!-- <div class="small-box">5</div>
      <div class="small-box">6</div>
      <div class="small-box">7</div>
      <div class="small-box">8</div> -->
        </aside>

        <main class="right">
            <!-- <h1>Main content</h1>
      <p>This area expands to fill the remaining width.</p>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit.</p> -->

            <!-- <div class="profile_container">
                <h2>User Profile</h2>
                <img src="https://img.icons8.com/ios-filled/50/000000/user.png" alt="User Icon"
                    style="position: absolute; top: 20px; right: 20px;"> -->


            <!-- <div class="field">
                    <label class="floating-label">Name</label>
                    <input type="text" placeholder="John Doe">
                </div>
                <div class="field">
                    <label class="floating-label">Email</label>
                    <input type="email" placeholder="email@gmail.com">
                </div>
                <div class="field">
                    <label class="floating-label">Phone</label>
                    <input type="tel" placeholder="+1234567890">
                </div>
                <div class="field">
                    <label class="floating-label">Password</label>
                    <input type="password" placeholder="********">
                </div> -->


            <!-- <div class="field">
                    <label class="floating-label">api key </label>
                    <input type="text" placeholder="api key " style="width:500px">
                </div><br>
                
                <div class="field">
                    <label class="floating-label">api secret </label>
                    <input type="text" placeholder="api secret "  style="width:500px">
                </div>
            </div> -->













            <nav style="margin: 30px 0;">
                <ul id="main-nav" style="display: flex; gap: 18px; list-style: none; padding: 0;">
                    <li><button class="nav-btn"
                            style="background: #0066ff; color: #fff; border: none; font-size: 17px; border-radius: 18px; padding: 7px 22px; cursor: pointer; font-weight: bold;"
                            onclick="change_layout('create',this)">Create
                            Strategy</button></li>
                    <li><button class="nav-btn"
                            style="background: none; color: #1976d2; border: none; font-size: 17px; border-radius: 18px; padding: 7px 22px; cursor: pointer; font-weight: bold;"
                            onclick="change_layout('my',this)">My
                            Strategies</button></li>
                    <li><button class="nav-btn"
                            style="background: none; color: #1976d2; border: none; font-size: 17px; border-radius: 18px; padding: 7px 22px; cursor: pointer; font-weight: bold;"
                            onclick="change_layout('deployed',this)">Deployed
                            Strategies</button></li>
                    <li><button class="nav-btn"
                            style="background: none; color: #1976d2; border: none; font-size: 17px; border-radius: 18px; padding: 7px 22px; cursor: pointer; font-weight: bold;"
                            onclick="change_layout('template',this)">Strategy
                            Template</button></li>
                    <li><button class="nav-btn"
                            style="background: none; color: #1976d2; border: none; font-size: 17px; border-radius: 18px; padding: 7px 22px; cursor: pointer; font-weight: bold;"
                            onclick="change_layout('portfolio',this)">
                            My Portfolio</button></li>
                    <li><button class="nav-btn"
                            style="background: none; color: #1976d2; border: none; font-size: 17px; border-radius: 18px; padding: 7px 22px; cursor: pointer; font-weight: bold;"
                            onclick="change_layout('api_container',this)">
                            API</button></li>
                </ul>
            </nav>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const navBtns = document.querySelectorAll('#main-nav .nav-btn');
                    navBtns.forEach(btn => {
                        btn.addEventListener('click', function () {
                            navBtns.forEach(b => {
                                b.style.background = 'none';
                                b.style.color = '#1976d2';
                                // b.style.fontWeight = 'normal';
                                // b.style.borderRadius = '';
                                // b.style.padding = '7px 0';
                            });
                            btn.style.background = '#0066ff';
                            btn.style.color = '#fff';
                            // btn.style.fontWeight = 'bold';
                            // btn.style.borderRadius = '18px';
                            // btn.style.padding = '7px 22px';
                        });
                    });
                });
            </script>





            <div class="create_s layout_strategy">


                <h2>Crypto Trading Dashboard</h2>

                <div class="form-container">
                    <div class="field">
                        <div class="order-type">
                            <label>
                                <input type="radio" name="order" value="FUTURE" checked>
                                <span>FUTURE</span>
                            </label>
                            <label>
                                <input type="radio" name="order" value="ARBITRAGE">
                                <span>FUTURE Arbitrage</span>
                            </label>
                        </div>
                    </div>

                    <div class="field" id="Brocker">
                        <label class="floating-label">Brocker</label>
                        <select name="Brocker" style="width:fit-content;">
                            <option value="Delta" selected>Delta</option>
                            <option value="Dcx">Dcx</option>
                        </select>
                    </div>

                    <div class="field">
                        <label class="floating-label">Timing</label>
                        <div class="order-type" id="timing-toggle">
                            <label>
                                <input type="radio" name="toggle" value="on">
                                <span>ON</span>
                            </label>
                            <label>
                                <input type="radio" name="toggle" value="off" checked>
                                <span>OFF</span>
                            </label>
                        </div>
                    </div>

                    <div id="timing-fields" style="display: none;">
                        <div class="field">
                            <label class="floating-label">Start time</label>
                            <input type="time" value="09:22">
                        </div>
                        <div class="field">
                            <label class="floating-label">Square off</label>
                            <input type="time" value="15:11">
                        </div>
                    </div>

                    <div class="field">
                        <div class="days">
                            <button class="active">MON</button>
                            <button class="active">TUE</button>
                            <button class="active">WED</button>
                            <button class="active">THU</button>
                            <button class="active">FRI</button>
                            <button class="active">SAT</button>
                            <button class="active">SUN</button>
                        </div>
                    </div>
                </div>
                <br>
                <hr>

                <h3>Legs</h3>
                <h2>total legs: <a id="total_legs" style="color: #1976d2;">1</a></h2>

                <div id="legs" style="position: relative; padding-bottom: 44px;">
                    <div class="legs-button" id="leg1"
                        style="display: flex; flex-direction: row; width: 100%; gap: 5px;">
                        <div class="legs-container" style="position: relative;">

                            <div class="field" style="display: none;">
                                <label class="floating-label" style="color: #0432ec; "><b>Brocker</b></label>
                                <select name="brocker_contact-1" style="width: fit-content;" required>
                                    <option value="" selected>Delta</option>
                                    <option value="">Dcx</option>
                                </select>
                            </div>

                            <div class="field">
                                <label class="floating-label">Contact</label>
                                <select id="contact-1" name="contact-1">
                                    <option value="" selected>--Select--</option>
                                    <option value="M-f">Max funding rate</option>
                                </select>
                            </div>


                            <div class="field">
                                <label class="floating-label">Buy/Sell</label>
                                <div class="order-type">
                                    <label>
                                        <input type="radio" name="buy-sell-1" value="BUY" checked>
                                        <span>BUY</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="buy-sell-1" value="SELL">
                                        <span>SELL</span>
                                    </label>
                                </div>
                            </div>

                            <div class="field">
                                <label class="floating-label">Type</label>
                                <div class="order-type">
                                    <label>
                                        <input type="radio" name="option-type-1" value="Market">
                                        <span>Market</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="option-type-1" value="Limit" checked>
                                        <span>Limit</span>
                                    </label>
                                </div>
                            </div>

                            <div class="field" id="l-price-field-1">
                                <label class="floating-label" for="l-price-label-1">L-Price</label>
                                <input type="number" id="l-price-1" placeholder="18000">
                            </div>

                            <div class="field" id="l-price-toggle-1">
                                <label class="floating-label">Limit</label>
                                <div class="order-type">
                                    <label>
                                        <input type="checkbox" id="best-bid-toggle-1">
                                        <span>Best Bid</span>
                                    </label>
                                </div>
                            </div>

                            <div class="field">
                                <label class="floating-label">T-C</label>
                                <div class="order-type">
                                    <label>
                                        <input type="radio" name="currency-type-1" value="USD">
                                        <span>USD</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="currency-type-1" value="INR" checked>
                                        <span>INR</span>
                                    </label>
                                </div>
                            </div>


                            <div class="field">
                                <label class="floating-label">Qty(Lot)</label>
                                <input type="number" class="qty-1" placeholder="1" value="1">
                            </div>

                            <div class="field">
                                <label class="floating-label">Amount/USD</label>
                                <input type="number" class="price-1" placeholder="150">
                            </div>

                            <div class="field">
                                <label class="floating-label">Lev-x</label>
                                <input style="width:90px;" type="number" id="Leverage-1" name="Leverage-1"
                                    placeholder="1" value="1" min="1" max="100" step="1">
                            </div>




                            <div class="field" id="f-r-p-type-1" style="display: none;">
                                <label class="floating-label">f-r-p</label>
                                <div class="order-type">
                                    <label>
                                        <input type="radio" name="f-r-p-1" value="+" checked>
                                        <span style="font-size: 20px;">+</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="f-r-p-1" value="-">
                                        <span style="font-size: 20px;">-</span>
                                    </label>
                                </div>
                            </div>

                            <hr>
                            <div class="contact_details-1"></div>
                            <hr>




                            <h3><input id="aExit-1" type="checkbox">Advanced:</h3>
                            <hr>

                            <div id="A-Controll-1" style="display: none;">



                                <div class="field" id="advanced-conditions">
                                    <div class="order-type condition" id="a-conditions-1"
                                        style="flex-wrap: wrap; padding: 0px; background-color: greenyellow; margin-bottom:5px; width: fit-content;">
                                        <label style="padding: 0px;">
                                            <select id="op-1" name="op-1"
                                                style="width: min-content;border-top-right-radius: 0px;border-bottom-right-radius: 0px;">
                                                <option value="" selected>--Select--</option>
                                                <option value="on time">on time</option>
                                                <option value="on Entry-price">on Entry-price</option>
                                                <option value="funding time">on next funding time</option>
                                                <option value="funding rate">on next funding rate</option>
                                                <option value="wallet balance">on wallet balance</option>
                                            </select>
                                        </label>
                                        <label style="padding: 0px;">
                                            <select id="op-s-1" name="op-s-1" style="width: 60px;border-radius: 0px;">
                                                <option value="=" selected>=</option>
                                                <option value="<">
                                                    << /option>
                                                <option value=">">></option>
                                                <option value="%">%</option>
                                                <option value="+">+</option>
                                                <option value="-">-</option>
                                            </select>
                                        </label>
                                        <label style="padding: 0px;">
                                            <input type="number" id="op-n-1" name="op-n-1" placeholder="6565"
                                                style="width: 100px;border-radius: 0px;">
                                        </label>
                                        <!-- <div class="field">
                                <label class="floating-label" for="trade-start-time-1">A-E-Time</label> -->
                                        <label style="padding: 0px;">
                                            <input type="time" id="trade-time-1" value="09:00:00" step="1"
                                                placeholder="09:00:00"
                                                style=" display:none; width: 130px;border-radius: 0px;">
                                        </label>
                                        <!-- </div> -->
                                        <label style="padding: 0px;">
                                            <select id="op-s2-1" name="op-s2-1"
                                                style="width: min-content;border-radius: 0px;">
                                                <option value="" selected>--Select--</option>
                                                <option value="BUY">BUY</option>
                                                <option value="EXIT">EXIT</option>
                                            </select>
                                        </label>
                                        <center>
                                            <label class="buttons"
                                                style="padding: 2px; display: flex; flex-direction: column; gap: 0; cursor:pointer;">
                                                <span class="add" style="color: black;">+</span>
                                                <span class="remove" style="color: black;">-</span>
                                            </label>
                                        </center>
                                    </div>
                                </div>


                                <br>


                                <div class="field" id="funding-fields-1">
                                    <label class="floating-label">CP</label>
                                    <input type="number" id="cp-1" placeholder="10000">
                                </div>
                                <div class="field" id="funding-fields-tp-1">
                                    <label class="floating-label">TP</label>
                                    <input type="number" id="tp-1" placeholder="20000">
                                </div>
                                <div class="field" id="funding-fields-sl-1">
                                    <label class="floating-label">SL</label>
                                    <input type="number" id="sl-1" placeholder="5000">
                                </div>
                            </div>



                            <hr>
                            <div class="field" style="margin-top: 20px; ">
                                <label class="floating-label">Strategy Name</label>
                                <input type="text" id="strategy-name-1" placeholder="Enter strategy name"
                                    style="width:300px;">
                            </div>



                            <div id="deploy-1"
                                style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 5px;">
                                <button class="save-btn" id="save-btn-1" style="
                            background: #0066ff;
                            color: #fff;
                            border: none;
                            border-radius: 20px;
                            padding: 8px 20px;
                            font-size: 15px;
                            cursor: pointer;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        ">Save</button>
                                <button class="deploy-btn" id="deploy-btn-1" style="
                            background: #00c853;
                            color: #fff;
                            border: none;
                            border-radius: 20px;
                            padding: 8px 20px;
                            font-size: 15px;
                            cursor: pointer;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        ">Deploy</button>
                            </div>



                        </div>


                        <div style="display: flex; flex-direction: column; margin-top: 50px;">
                            <button class="copy_leg leg1" title="Copy Leg"
                                style="background: none; border: none; cursor: pointer; padding: 4px;">
                                <img src="https://img.icons8.com/material-outlined/24/000000/copy.png" alt="Copy" />
                            </button>
                            <button class="delete_leg leg1" title="Delete Leg"
                                style="background: none; border: none; cursor: pointer; padding: 4px;">
                                <img src="https://img.icons8.com/material-outlined/24/000000/delete-sign.png"
                                    alt="Delete" />
                            </button>
                        </div>
                    </div>

                    <div id="extra-legs"></div>
                    <button id="add-leg-btn" style="
                position: absolute;
                bottom: 4px;
                right: 0;
                background: #0066ff;
                color: #fff;
                border: none;
                border-radius: 20px;
                padding: 8px 20px;
                font-size: 15px;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            ">+ Add Leg</button>
                </div>

            </div>


            <div class="my_strategy layout_strategy" style="display: none;">
                <h2>total strategy: <a id="total_legs" style="color: #1976d2;">1</a></h2>
                <div class="">hii</div>
            </div>



            <div class="deployed_strategies layout_strategy" style="display: none;">

                <div id="strategy-status">
                    <h3>Strategy Status</h3>
                    <button id="start-btn" type="button"
                        style="background:#0066ff;color:#fff;border:none;border-radius:10px;padding:6px 18px;margin-right:10px;cursor:pointer;">Start</button>
                    <button id="stop-btn" type="button"
                        style="background:#d32f2f;color:#fff;border:none;border-radius:10px;padding:6px 18px;cursor:pointer;">Stop</button>

                    <p>Running: <span id="running-status" style="color:red;">No</span></p>
                    <p>Last Signal: <span id="last-signal">NONE</span></p>
                    <p>PNL: <span id="pnl-value" style="color:red;">0.00</span></p>

                    <h4>Positions:</h4>
                    <ul id="positions"></ul>

                    <h4>Strategy Legs:</h4>
                    <div id="my_legs"></div>
                </div>

            </div>


            <div class="portfolio layout_strategy" style="display: none;">
                <h2 style="color: #007bff;">active order status :</h2>
                <div class="active_order_position"></div>
                <h2 style="color: #007bff;">positions status :</h2>
                <div class="position"></div>
                <!-- <div class="">hii</div> -->
            </div>

            <div class="api_container layout_strategy" style="display: none;">
                <h2>&nbsp;&nbsp;API credentials :</h2>

                <div class="card"
                    style="background:#fff;padding:16px;border-radius:8px;max-width:640px;box-shadow:0 6px 18px rgba(20,30,60,0.06)">
                    <h3>(Delta)</h3>

                    <!-- Display mode -->
                    <div id="displayMode">
                        <div class="row" style="display:flex;align-items:center;gap:12px;margin:8px 0">
                            <label style="min-width:90px;color:#555">api key</label>
                            <input type="text" id="apiKeyText" class="value" placeholder="api key "
                                style="padding:8px 10px;border-radius:6px;background:#f1f5f9;border:1px solid #e6eef8;min-width:320px">
                            <!-- api key</div> -->
                            <div class="buttons" style="display:flex;gap:8px;margin-left:auto">
                                <button id="editBtn"
                                    style="padding:6px 10px;border-radius:6px;border:0;background:#2563eb;color:#fff;cursor:pointer">Edit</button>
                            </div>
                        </div>

                        <div class="row" style="display:flex;align-items:center;gap:12px;margin:8px 0">
                            <label style="min-width:90px;color:#555">api secret</label>
                            <input id="apiSecretText" class="value" placeholder="api secret "
                                style="padding:8px 10px;border-radius:6px;background:#f1f5f9;border:1px solid #e6eef8;min-width:320px">
                            <!-- ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div> -->

                            <div style="display:flex;gap:8px;align-items:center;margin-left:auto">
                                <button id="toggleSecret" class="ghost"
                                    style="padding:6px 10px;border-radius:6px;border:0;background:#e6eef8;color:#0b2a66;cursor:pointer">Show</button>
                                <button id="editSecretBtn"
                                    style="padding:6px 10px;border-radius:6px;border:0;background:#2563eb;color:#fff;cursor:pointer">Edit</button>
                            </div>
                        </div>

                        <div class="small" style="font-size:13px;color:#666;margin-top:8px">
                            Click <strong>Edit</strong> to change values. Secret is masked by default.
                        </div>
                    </div>

                    <!-- Edit mode -->
                    <div id="editMode" style="display:none">
                        <div class="row" style="display:flex;align-items:center;gap:12px;margin:8px 0">
                            <label style="min-width:90px;color:#555">api key</label>
                            <input id="apiKeyInput" type="text" placeholder="api key"
                                style="padding:8px 10px;border-radius:6px;border:1px solid #ccd7e6;min-width:320px" />
                        </div>

                        <div class="row" style="display:flex;align-items:center;gap:12px;margin:8px 0">
                            <label style="min-width:90px;color:#555">api secret</label>
                            <input id="apiSecretInput" type="text" placeholder="api secret"
                                style="padding:8px 10px;border-radius:6px;border:1px solid #ccd7e6;min-width:320px" />
                        </div>

                        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                            <button id="saveBtn"
                                style="padding:6px 10px;border-radius:6px;border:0;background:#2563eb;color:#fff;cursor:pointer">Save</button>
                            <button id="cancelBtn" class="ghost"
                                style="padding:6px 10px;border-radius:6px;border:0;background:#e6eef8;color:#0b2a66;cursor:pointer">Cancel</button>
                        </div>
                    </div>
                    <div id="apiStatus"
                        style="margin-top:12px;font-size:14px;display:none;padding:10px;border-radius:6px">
                    </div>
                </div>




                <div class="card"
                    style="background:#fff;padding:16px;margin-top:8px;max-width:640px;box-shadow:0 6px 18px rgba(20,30,60,0.06)">
                    <h3>(DCX)</h3>

                    <!-- Display mode -->
                    <div id="displayMode2">
                        <div class="row" style="display:flex;align-items:center;gap:12px;margin:8px 0">
                            <label style="min-width:90px;color:#555">api key</label>
                            <input type="text" id="apiKeyText2" class="value" placeholder="api key "
                                style="padding:8px 10px;border-radius:6px;background:#f1f5f9;border:1px solid #e6eef8;min-width:320px">
                            <!-- api key</div> -->
                            <div class="buttons" style="display:flex;gap:8px;margin-left:auto">
                                <button id="editBtn2"
                                    style="padding:6px 10px;border-radius:6px;border:0;background:#2563eb;color:#fff;cursor:pointer">Edit</button>
                            </div>
                        </div>

                        <div class="row" style="display:flex;align-items:center;gap:12px;margin:8px 0">
                            <label style="min-width:90px;color:#555">api secret</label>
                            <input id="apiSecretText2" class="value" placeholder="api secret "
                                style="padding:8px 10px;border-radius:6px;background:#f1f5f9;border:1px solid #e6eef8;min-width:320px">
                            <!-- ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div> -->

                            <div style="display:flex;gap:8px;align-items:center;margin-left:auto">
                                <button id="toggleSecret2" class="ghost"
                                    style="padding:6px 10px;border-radius:6px;border:0;background:#e6eef8;color:#0b2a66;cursor:pointer">Show</button>
                                <button id="editSecretBtn2"
                                    style="padding:6px 10px;border-radius:6px;border:0;background:#2563eb;color:#fff;cursor:pointer">Edit</button>
                            </div>
                        </div>

                        <div class="small" style="font-size:13px;color:#666;margin-top:8px">
                            Click <strong>Edit</strong> to change values. Secret is masked by default.
                        </div>
                    </div>

                    <!-- Edit mode -->
                    <div id="editMode2" style="display:none">
                        <div class="row" style="display:flex;align-items:center;gap:12px;margin:8px 0">
                            <label style="min-width:90px;color:#555">api key</label>
                            <input id="apiKeyInput2" type="text" placeholder="api key"
                                style="padding:8px 10px;border-radius:6px;border:1px solid #ccd7e6;min-width:320px" />
                        </div>

                        <div class="row" style="display:flex;align-items:center;gap:12px;margin:8px 0">
                            <label style="min-width:90px;color:#555">api secret</label>
                            <input id="apiSecretInput2" type="text" placeholder="api secret"
                                style="padding:8px 10px;border-radius:6px;border:1px solid #ccd7e6;min-width:320px" />
                        </div>

                        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                            <button id="saveBtn2"
                                style="padding:6px 10px;border-radius:6px;border:0;background:#2563eb;color:#fff;cursor:pointer">Save</button>
                            <button id="cancelBtn2" class="ghost"
                                style="padding:6px 10px;border-radius:6px;border:0;background:#e6eef8;color:#0b2a66;cursor:pointer">Cancel</button>
                        </div>
                    </div>
                    <div id="apiStatus2"
                        style="margin-top:12px;font-size:14px;display:none;padding:10px;border-radius:6px">
                    </div>
                </div>

            </div>


            <div class="template layout_strategy" style="display: none;">
                <h2>Strategy Template</h2>
                <!-- <div onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"
                    style="
    max-width:max-content;
    padding:20px 24px;
    border-radius:14px;
    background:linear-gradient(135deg,rgb(0, 102, 255),#5c9bb0,#2c5364);
    color:#ffffff;
    font-family:Segoe UI, sans-serif;
    font-size:18px;
    font-weight:600;
    letter-spacing:0.5px;
    box-shadow:0 12px 30px rgb(154, 161, 171);
">Arbitrage
                    <-- Delta Exchange ‚Äì CoinDCX Arbitrage Strategy -->
                <!-- </div>  -->




                <!-- ================= STRATEGY SELECTION ================= -->
                <div class="selection" id="selection">
                    <div class="card" onclick="openStrategy('Arbitrage')">Arbitrage</div>
                    <div class="card" onclick="openStrategy('Scalping')">Scalping</div>
                    <div class="card" onclick="openStrategy('Swing')">Swing</div>
                    <div class="card" onclick="openStrategy('Futures')">Futures</div>
                </div>
                <!-- ================= STRATEGY VIEW ================= -->
                <div class="strategy" id="strategy">
                    <div class="top">
                        <button onclick="goBack()">‚¨Ö Back</button>

                        <span class="strategy_label" style="display: flex; gap: 10px;">
                            <button onclick="showHistory()">üìú History</button>



                            <div class="">
                                Diff ‚â•
                                <input type="number" id="diffInput" value="0.1" step="0.001"
                                    style="width:90px; padding:4px;" />
                            </div>

                            <button onclick="toggleMaxDiff()" style="margin-left:10px;">
                                üî• Max Diff Only
                            </button>
                        </span>
                        <!-- ‚öôÔ∏è SETTINGS BUTTON -->
                        <button class="settings-btn opacity" onclick="openSettings()">‚öôÔ∏è</button>


                        <div class="heading" id="title"></div>
                    </div>

                    <div></div>

                    <div class="loader" id="loader"></div>

                    <table class="hidden" id="table">
                        <thead>
                            <tr>
                                <!-- <th>Delta Price</th>
                                <th>Delta Funding</th>
                                <th>Delta Fund Time</th>
                                <th>Coin DCX Price</th>
                                <th>DCX Funding</th>
                                <th>DCX Fund Time</th>
                                <th>Diff</th>
                                <th>Signal</th> -->
                                <th>Symbol</th>
                                <th>EX Funding</th>
                                <th>DCX Funding</th>
                                <th>Diff</th>
                                <th>DCX Price</th>
                                <th>DCX Funding In</th>
                                <th>EX Funding In</th>
                                <th>Signal</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>

                    <div class="settings hidden" id="settingsPanel">
                        <div class="settings-header">
                            <h3>Strategy Settings</h3>
                            <button onclick="closeSettings()">‚úñ</button>
                        </div>

                        <div class="settings-body">
                            <p><b>Selected Coin:</b> <span id="selectedCoin">None</span></p>

                            <label>
                                Min Leverage:
                                <input id="A_leverage_min" type="number" value="5" style="width: 40px;">
                            </label> &nbsp;

                            <label>
                                Max Leverage:
                                <input id="A_leverage_max" type="number" value="5" style="width: 40px;">
                            </label> <br><br>

                            <label>
                                Order Size (USDT):
                                <input id="A_orderSize" type="number" value="50" style="width: 40px;">
                            </label><br><br>

                            <label>
                                Auto Execute:
                                <input type="checkbox">
                            </label>
                            <!-- üöÄ START BUTTON -->
                            <button class="start-btn" onclick="startInitialize()">
                                ‚ñ∂ Start / Initialize
                            </button>
                        </div>
                    </div>


                    <div class="history hidden" id="history">
                        <h3>Trade Signal History</h3>
                        <ul id="log"></ul>
                    </div>
                </div>

            </div>

        </main>
    </div>



    <script>
        async function startInitialize() {
            const coin = document.getElementById("selectedCoin").innerText;
            const orderSize = document.getElementById("A_orderSize").value;
            const leverage_min = document.getElementById("A_leverage_min").value;
            const leverage_max = document.getElementById("A_leverage_max").value;

            if (!coin || coin === "None") {
                alert("Please select a coin first!");
                return;
            }

            const payload = {
                id: userId,
                symbol: coin,
                order_size: Number(orderSize),
                leverage_min: Number(leverage_min),
                leverage_max: Number(leverage_max),
                strategy: currentStrategy,
                delta_balance_usd: await get_balance(),
                dcx_balance_usd: await get_balance_dcx()
            };

            try {
                const res = await fetch("/start_initialize", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.success) {
                    alert("‚úÖ Strategy Initialized for " + coin);
                } else {
                    alert("‚ùå Failed: " + data.error);
                }

            } catch (err) {
                console.error(err);
                alert("Server error");
            }
        }

        let showMaxOnly = false;


        function showHistory() {
            history.classList.toggle('hidden');
            table.classList.toggle('hidden');
        }

        function toggleMaxDiff() {
            showMaxOnly = !showMaxOnly;
            event.target.innerText = showMaxOnly ? "üìä Show All" : "üî• Max Diff Only";
            loadData();
        }



        function getDiffThreshold() {
            const el = document.getElementById("diffInput");
            return el ? Number(el.value) : 0.1;
        }

        function closeSettings() {
            document.querySelector(".strategy_label").classList.remove("opacity");
            document.getElementById("settingsPanel").classList.add("hidden");
            table.classList.remove("hidden");
            // history.classList.remove("hidden");
            // ‚úÖ deactivate settings button
            document.querySelector(".settings-btn").classList.remove("active");
        }

        function openSettings(symbol = null) {

            if (document.querySelector(".settings-btn").classList.contains("active")) {
                // alert("dd");
                closeSettings();
                return
            }
            document.querySelector(".strategy_label").classList.add("opacity");
            table.classList.add("hidden");
            history.classList.add("hidden");
            document.getElementById("settingsPanel").classList.remove("hidden");
            // ‚úÖ activate settings button
            document.querySelector(".settings-btn").classList.add("active");


            if (symbol) {
                document.getElementById("selectedCoin").innerText = symbol;
            }
        }





        let interval;
        let currentStrategy = "";

        /* ===== DOM REFERENCES (FIX) ===== */
        const selection = document.getElementById("selection");
        const strategy = document.getElementById("strategy");
        const title = document.getElementById("title");
        const loader = document.getElementById("loader");
        const table = document.getElementById("table");
        const history = document.getElementById("history");
        const tbody = document.getElementById("tbody");
        const log = document.getElementById("log");
        log.style.display = "none";

        let settings_btn = document.querySelector(".settings-btn");



        /* ================= OPEN STRATEGY ================= */
        function openStrategy(name) {
            currentStrategy = name;
            selection.style.display = "none";
            strategy.style.display = "flex";
            title.innerText = name + " Strategy";

            setTimeout(() => {
                loader.classList.add("hidden");
                table.classList.remove("hidden");

                settings_btn.classList.remove("opacity");

                // history.classList.remove("hidden");
                // update();
                // interval = setInterval(update, 1000);
                // loadData();
                // interval = loadData(loadData, 1000);

            }, 1500);
        }


        /* ================= BACK ================= */
        function goBack() {
            clearInterval(interval);
            strategy.style.display = "none";
            selection.style.display = "flex";
            tbody.innerHTML = "";
            log.innerHTML = "";
            loader.classList.remove("hidden");
            table.classList.add("hidden");
            history.classList.add("hidden");
        }

        /* ================= HELPERS ================= */
        function rand(min, max) { return (Math.random() * (max - min) + min).toFixed(2); }
        function randFunding() { return (Math.random() * 0.06 - 0.03).toFixed(4); }

        function fundTime() {
            let mins = Math.floor(Math.random() * 480);
            let h = String(Math.floor(mins / 60)).padStart(2, '0');
            let m = String(mins % 60).padStart(2, '0');
            return `${h}:${m}:00`;
        }

        /* ================= STRATEGY LOGIC ================= */
        function strategyLogic(diff, df, cf) {
            if (currentStrategy === "Arbitrage") {
                if (diff > 120 && df < cf) return "BUY DCX / SELL Delta";
                if (diff < 110 && df > cf) return "BUY Delta / SELL DCX";
            }
            if (currentStrategy === "Scalping") {
                if (diff > 115) return "BUY";
                if (diff < 113) return "SELL";
            }
            if (currentStrategy === "Swing") {
                if (diff > 130) return "BUY";
                if (diff < 105) return "SELL";
            }
            if (currentStrategy === "Futures") {
                if (df > 0.01) return "SHORT";
                if (df < -0.01) return "LONG";
            }
            return "HOLD";
        }

        async function loadData() {
            const res = await fetch("/funding_arbitrage?user_id=" + userId);
            const data = await res.json();
            // const tbody = document.getElementById("body");

            // console.log("data :", data)

            let rows = data;

            // üî• ONLY MAX DIFF MODE
            if (showMaxOnly && data.length > 0) {
                let maxItem = data.reduce((a, b) =>
                    Math.abs(b.funding_diff) > Math.abs(a.funding_diff) ? b : a
                );
                rows = [maxItem];
            }

            tbody.innerHTML = rows.map(d => {
                const diff = Number(d.funding_diff);

                const threshold = getDiffThreshold() || 0.1;

                let rowClass = "";
                if (diff >= threshold) rowClass = "row-strong-pos";
                else if (diff <= -threshold) rowClass = "row-strong-pos";

                return `
        <tr class="${rowClass}">
            <td>${d.symbol}</td>
            <td>${Number(d.ex_funding).toFixed(6)}</td>
            <td>${Number(d.dcx_funding).toFixed(6)}</td>
            <td>${diff.toFixed(6)}</td>
            <td>${d.dcx_price}</td>
            <td>${d.dcx_funding_time}</td>
            <td>${d.ex_funding_time}</td>
            <td class="${d.signal.includes('LONG') ? 'buy' : d.signal.includes('SHORT') ? 'sell' : ''}"
            style="cursor:pointer; text-decoration:underline"
            onclick="openSettings('${d.symbol}')"
            >${d.signal}</td>
        </tr>
    `;
            }).join("");

        }


        /* ================= UPDATE LOOP ================= */
        //     function update() {
        //         const deltaPrice = rand(100, 200);
        //         const dcxPrice = rand(100, 200);
        //         const diff = (dcxPrice - deltaPrice).toFixed(2);

        //         const deltaFund = randFunding();
        //         const dcxFund = randFunding();

        //         const deltaTime = fundTime();
        //         const dcxTime = fundTime();

        //         const signal = strategyLogic(diff, deltaFund, dcxFund);

        //         let cls = signal.includes("BUY") || signal.includes("LONG") ? "buy" :
        //             signal.includes("SELL") || signal.includes("SHORT") ? "sell" : "";

        //         tbody.innerHTML = `
        //     <tr>
        //         <td>${deltaPrice}</td>
        //         <td>${deltaFund}%</td>
        //         <td>${deltaTime}</td>
        //         <td>${dcxPrice}</td>
        //         <td>${dcxFund}%</td>
        //         <td>${dcxTime}</td>
        //         <td>${diff}</td>
        //         <td class="${cls}">${signal}</td>
        //     </tr>
        // `;

        //         // if (signal !== "HOLD") {
        //         //     const t = new Date().toLocaleTimeString();
        //         //     log.innerHTML =
        //         //         `<li>[${t}] ${currentStrategy} ‚Üí ${signal} | Diff ${diff} | ŒîF ${deltaFund}% / DCX ${dcxFund}%</li>`
        //         //         + log.innerHTML;
        //         // }
        //     }


    </script>


    <script>
        function showPrice() {
            const marquee = document.getElementById("crypto-marquee");
            marquee.className = "show-price";
        }

        function showFunding() {
            const marquee = document.getElementById("crypto-marquee");
            marquee.className = "show-funding";
        }
    </script>



    <script>




        let funding_data = JSON.parse(localStorage.getItem("fundingData") || "{}");
        let funding_data_dcx = JSON.parse(localStorage.getItem("fundingDataDcx") || "{}");

        let selected = JSON.parse(localStorage.getItem("selectedSymbols") || "[]");

        let binance_funding = {}

        let all_tickers_data = [];
        let all_tickers_data_dcx = {};





        let Best_bid_toggle = false;


        // Initialize leg count
        let legCount = 1;
        let a_condition = 1;



        function getSelected() {
            return JSON.parse(localStorage.getItem("selectedSymbols")) || {};
        }

        function setSelected(obj) {
            localStorage.setItem("selectedSymbols", JSON.stringify(obj));
        }


        // Function to update total legs count
        function updateTotalLegs() {
            const totalLegs = document.querySelectorAll('.legs-button').length;
            document.getElementById('total_legs').textContent = totalLegs;
            updateSelectedFromActiveLegs();
        }



        function saveLegsToJson2(legIndex, random_id = 0) {
            const leg = document.getElementById(`leg${legIndex}`);
            if (!leg) return null;

            const brokerSelect = document.querySelector('#Brocker select');
            const option = brokerSelect.options[brokerSelect.selectedIndex];

            const legData = {
                id: random_id,
                brocker: leg.querySelector('select[name^="brocker_contact-"]')?.closest('.field')?.offsetParent
                    ? leg.querySelector('select[name^="brocker_contact-"]').selectedOptions[0].text
                    : null
                    || option?.value,
                Brocker: leg.querySelector('select[name^="brocker_contact-"]')?.closest('.field')?.offsetParent
                    ? leg.querySelector('select[name^="brocker_contact-"]').selectedOptions[0].text
                    : null
                    || option?.value,
                legId: `leg${legIndex}`,
                Sname: leg.querySelector(`#strategy-name-${legIndex}`)?.value || '',
                buySell: leg.querySelector(`input[name="buy-sell-${legIndex}"]:checked`)?.value || 'BUY',
                type: leg.querySelector(`input[name="option-type-${legIndex}"]:checked`)?.value || 'Limit',
                lPrice: leg.querySelector(`input[id="l-price-${legIndex}"]`)?.value || '',
                bestBid: leg.querySelector(`#best-bid-toggle-${legIndex}`)?.checked || false,
                qty: leg.querySelector(`.qty-${legIndex}`)?.value || '1',
                price: leg.querySelector(`.price-${legIndex}`)?.value || '0',
                leverage: leg.querySelector(`#Leverage-${legIndex}`)?.value || '1',
                contact: leg.querySelector(`#contact-${legIndex}`)?.value || '',
                productId: leg.querySelector(`#contact-${legIndex}`)?.querySelector(`option[value="${leg.querySelector(`#contact-${legIndex}`)?.value}"]`).id || '',
                frp: leg.querySelector(`input[name="f-r-p-${legIndex}"]:checked`)?.value || '',
                aExit: leg.querySelector(`#aExit-${legIndex}`)?.checked || false,
                // autoEBy: leg.querySelector(`#auto-e-${legIndex}`)?.value || '',
                advanced: [],
                cp: leg.querySelector(`#cp-${legIndex}`)?.value || '',
                tp: leg.querySelector(`#tp-${legIndex}`)?.value || '',
                sl: leg.querySelector(`#sl-${legIndex}`)?.value || ''
            };

            // Collect Advanced conditions
            // const advancedConditions = leg.querySelectorAll('.condition');
            // advancedConditions.forEach(cond => {
            //     const conditionData = {
            //         op: cond.querySelector(`#op-${legIndex}`)?.value || '',
            //         opS: cond.querySelector(`#op-s-${legIndex}`)?.value || '',
            //         opN: cond.querySelector(`#op-n-${legIndex}`)?.value || '',
            //         aETime: leg.querySelector(`#trade-time-${legIndex}`)?.value || '00:00',
            //         opS2: cond.querySelector(`#op-s2-${legIndex}`)?.value || ''
            //     };
            //     legData.advanced.push(conditionData);
            // });

            //  console.log(legIndex)
            const advancedConditions = leg.querySelectorAll('.condition');
            advancedConditions.forEach(cond => {
                const conditionData = {

                    op: cond.querySelector(`select[id^="op-"]`)?.value || '',
                    opS: cond.querySelector(`select[id^="op-s-"]`)?.value || '',
                    opN: cond.querySelector(`input[id^="op-n-"]`)?.value || '',
                    aETime: cond.querySelector(`input[id^="trade-time-"]`)?.value || '00:00:00',
                    opS2: cond.querySelector(`select[id^="op-s2-"]`)?.value || ''
                };

                // console.log(conditionData)

                // Only push if not empty
                if (conditionData.op || conditionData.opS || conditionData.opN || conditionData.opS2) {
                    legData.advanced.push(conditionData);
                }
            });


            return JSON.stringify(legData, null, 2);
        }

        // Function to collect data from all legs and return as JSON
        function saveLegsToJson() {
            const legs = [];
            const legElements = document.querySelectorAll('.legs-button');

            const brokerSelect = document.querySelector('#Brocker select');
            const option = brokerSelect.options[brokerSelect.selectedIndex];

            legElements.forEach((leg, index) => {
                const legId = `leg${index + 1}`;
                const legData = {
                    legId: legId,
                    brocker: leg.querySelector('select[name^="brocker_contact-"]')?.closest('.field')?.offsetParent
                        ? leg.querySelector('select[name^="brocker_contact-"]').selectedOptions[0].text
                        : null
                        || option?.value,
                    Sname: leg.querySelector(`#strategy-name-${index + 1}`)?.value || '',
                    buySell: leg.querySelector(`input[name="buy-sell-${index + 1}"]:checked`)?.value || 'BUY',
                    type: leg.querySelector(`input[name="option-type-${index + 1}"]:checked`)?.value || 'Limit',
                    lPrice: leg.querySelector(`input[id="l-price-${index + 1}"]`)?.value || '',
                    bestBid: leg.querySelector(`#best-bid-toggle-${index + 1}`)?.checked || false,
                    qty: leg.querySelector(`.qty-${index + 1}`)?.value || '1',
                    price: leg.querySelector(`.price-${index + 1}`)?.value || '0',
                    leverage: leg.querySelector(`#Leverage-${index + 1}`)?.value || '1',
                    contact: leg.querySelector(`#contact-${index + 1}`)?.value || '',
                    productId: leg.querySelector(`#contact-${index + 1}`)?.querySelector(`option[value="${leg.querySelector(`#contact-${index + 1}`)?.value}"]`).id || '',
                    frp: leg.querySelector(`input[name="f-r-p-${index + 1}"]:checked`)?.value || '',
                    aExit: leg.querySelector(`#aExit-${index + 1}`)?.checked || false,
                    // autoEBy: leg.querySelector(`#auto-e-${index + 1}`)?.value || '',
                    advanced: [],
                    cp: leg.querySelector(`#cp-${index + 1}`)?.value || '',
                    tp: leg.querySelector(`#tp-${index + 1}`)?.value || '',
                    sl: leg.querySelector(`#sl-${index + 1}`)?.value || ''
                };


                // Collect Advanced conditions
                const advancedConditions = leg.querySelectorAll('.condition');
                advancedConditions.forEach(cond => {
                    const conditionData = {
                        op: cond.querySelector(`select[id^="op-"]`)?.value || '',
                        opS: cond.querySelector(`select[id^="op-s-"]`)?.value || '',
                        opN: cond.querySelector(`input[id^="op-n-"]`)?.value || '',
                        aETime: cond.querySelector(`input[id^="trade-time-"]`)?.value || '00:00:00',
                        opS2: cond.querySelector(`select[id^="op-s2-"]`)?.value || ''
                    };
                    legData.advanced.push(conditionData);
                });

                legs.push(legData);

            });

            return JSON.stringify(legs, null, 2);
        }

        // Add Leg functionality
        document.getElementById('add-leg-btn').addEventListener('click', function () {
            legCount++;
            const extraLeg = document.createElement('div');
            extraLeg.innerHTML = `
                <div class="legs-button" id="leg${legCount}" style="display: flex; flex-direction: row; width: 100%; gap: 5px;">
                    <div class="legs-container" style="position: relative;">

                        <div class="field" style="display: none;">
                            <label class="floating-label" style="color: #0432ec; "><b>Brocker</b></label>
                            <select name="brocker_contact-${legCount}" style="width: fit-content;" required>
                                <option value="" selected>Delta</option>
                                <option value="">Dcx</option>
                            </select>
                        </div>

                        <div class="field">
                            <label class="floating-label">Contact</label>
                            <select id="contact-${legCount}" name="contact-${legCount}">
                                <option value="" selected>--Select--</option>
                                <option value="Max-funding">Max funding rate</option>
                            </select>
                        </div>


                        <div class="field">
                            <label class="floating-label">Buy/Sell</label>
                            <div class="order-type">
                                <label>
                                    <input type="radio" name="buy-sell-${legCount}" value="BUY" checked>
                                    <span>BUY</span>
                                </label>
                                <label>
                                    <input type="radio" name="buy-sell-${legCount}" value="SELL">
                                    <span>SELL</span>
                                </label>
                            </div>
                        </div>
                        <div class="field">
                            <label class="floating-label">Type</label>
                            <div class="order-type">
                                <label>
                                    <input type="radio" name="option-type-${legCount}" value="Market">
                                    <span>Market</span>
                                </label>
                                <label>
                                    <input type="radio" name="option-type-${legCount}" value="Limit" checked>
                                    <span>Limit</span>
                                </label>
                            </div>
                        </div>
                        <div class="field" id="l-price-field-${legCount}">
                            <label class="floating-label" for="l-price-label-${legCount}">L-Price</label>
                            <input type="number" id="l-price-${legCount}" placeholder="18000">
                        </div>
                        <div class="field" id="l-price-toggle-${legCount}">
                            <label class="floating-label">Limit</label>
                            <div class="order-type">
                                <label>
                                    <input type="checkbox" id="best-bid-toggle-${legCount}">
                                    <span>Best Bid</span>
                                </label>
                            </div>
                        </div>


                        <div class="field">
                    <label class="floating-label">T-C</label>
                    <div class="order-type">
                        <label>
                            <input type="radio" name="currency-type-${legCount}" value="USD">
                            <span>USD</span>
                        </label>
                        <label>
                            <input type="radio" name="currency-type-${legCount}" value="INR" checked>
                            <span>INR</span>
                        </label>
                    </div>
                </div>

                        <div class="field">
                            <label class="floating-label">Qty</label>
                            <input type="number" class="qty-${legCount}" placeholder="1" value="1">
                        </div>
                        <div class="field">
                            <label class="floating-label">Amount/USD</label>
                            <input type="number" class="price-${legCount}" placeholder="150">
                        </div>




                        <div class="field">
                    <label class="floating-label">Lev-x</label>
                    <input style="width:90px;" type="number" id="Leverage-${legCount}" name="Leverage-${legCount}" placeholder="1" value="1"
                        min="1" max="100" step="1">
                </div>



                 <div class="field" id="f-r-p-type-${legCount}" style="display: none;"> 
                    <label class="floating-label">f-r-p</label>
                    <div class="order-type">
                        <label>
                            <input type="radio" name="f-r-p-${legCount}" value="+" checked>
                            <span style="font-size: 20px;">+</span>
                        </label>
                        <label>
                            <input type="radio" name="f-r-p-${legCount}" value="-">
                            <span style="font-size: 20px;">-</span>
                        </label>
                    </div>
                </div>

                 <hr>
                <div class="contact_details-${legCount}"></div>
                <hr>

             


                <h3><input id="aExit-${legCount}" type="checkbox">Advanced:</h3>
                <hr>
                <div id="A-Controll-${legCount}" style="display: none;">

                

                <div class="field" id="advanced-conditions">
                    <div class="order-type condition"
                        style="flex-wrap: wrap; padding: 0px; background-color: greenyellow; margin-bottom:5px; width: fit-content;">
                        <label style="padding: 0px;">
                            <select id="op-${legCount}" name="op-${legCount}" style="width: min-content;border-top-right-radius: 0px;border-bottom-right-radius: 0px;">
                                <option value="" selected>--Select--</option>
                                <option value="on time">on time</option>
                                <option value="on Entry-price">on Entry-price</option>
                                <option value="funding time">on next funding time</option>
                                <option value="funding rate">on next funding rate</option>
                                <option value="wallet balance">on wallet balance</option>
                            </select>
                        </label>
                        <label style="padding: 0px;">
                            <select id="op-s-${legCount}" name="op-s-${legCount}" style="width:60px;border-radius: 0px;">
                                <option value="=" selected>=</option>
                                <option value="<"><</option>
                                <option value=">">></option>
                                <option value="%">%</option>
                                <option value="+">+</option>
                                <option value="-">-</option>
                            </select>
                        </label>
                        <label style="padding: 0px;">
                            <input type="number" id="op-n-${legCount}" name="op-n-${legCount}" placeholder="6565" style="width: 100px;border-radius: 0px;">
                        </label>
                        
                          
                                <label style="padding: 0px;">
                                <input type="time" id="trade-time-${legCount}" value="09:00:00" step="1" placeholder="09:00:00" style=" display:none;border-radius: 0px;">
                                </label>
                        <label style="padding: 0px;">
                            <select id="op-s2-${legCount}" name="op-s2-${legCount}" style="width: min-content;border-radius: 0px;">
                                <option value="" selected>--Select--</option>
                                <option value="BUY">BUY</option>
                                <option value="EXIT">EXIT</option>
                            </select>
                        </label>
                        <label class="buttons"
                            style="padding: 2px; display: flex; flex-direction: column; gap: 0; cursor:pointer;">
                            <span class="add" style="color: black;">+</span>
                            <span class="remove" style="color: black;">-</span>
                        </label>
                    </div>
                </div>


                <br>



                <div class="field" id="funding-fields-1">
                    <label class="floating-label">CP</label>
                    <input type="number" id="cp-${legCount}" placeholder="10000">
                </div>
                <div class="field" id="funding-fields-tp-1">
                    <label class="floating-label">TP</label>
                    <input type="number" id="tp-${legCount}" placeholder="20000">
                </div>
                <div class="field" id="funding-fields-sl-1">
                    <label class="floating-label">SL</label>
                    <input type="number" id="sl-${legCount}" placeholder="5000">
                </div>

                </div>


                <hr>
                <div class="field" style="margin-top: 20px;">
                    <label class="floating-label">Strategy Name</label>
                    <input type="text" id="strategy-name-${legCount}" placeholder="Enter strategy name" style="width: 300px;">
                </div>


                <div id="deploy-${legCount}" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 5px;">
                    <button class="save-btn" id="save-btn-${legCount}" style="
                            background: #0066ff;
                            color: #fff;
                            border: none;
                            border-radius: 20px;
                            padding: 8px 20px;
                            font-size: 15px;
                            cursor: pointer;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        ">Save</button>
                    <button class="deploy-btn" id="deploy-btn-${legCount}" style="
                            background: #00c853;
                            color: #fff;
                            border: none;
                            border-radius: 20px;
                            padding: 8px 20px;
                            font-size: 15px;
                            cursor: pointer;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        ">Deploy</button>
                </div>



                    </div>
                    <div style="display: flex; flex-direction: column; margin-top: 50px;">
                        <button class="copy_leg leg${legCount}" title="Copy Leg"
                            style="background: none; border: none; cursor: pointer; padding: 4px;">
                            <img src="https://img.icons8.com/material-outlined/24/000000/copy.png" alt="Copy" />
                        </button>
                        <button class="delete_leg leg${legCount}" title="Delete Leg"
                            style="background: none; border: none; cursor: pointer; padding: 4px;">
                            <img src="https://img.icons8.com/material-outlined/24/000000/delete-sign.png" alt="Delete" />
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('extra-legs').appendChild(extraLeg);
            updateTotalLegs();
        });



        function check_s_name(name) {
            //check this name alredy exit or not ?......
            if (name) {
                return true
            } else {
                return false
            }
        }


        function generate10DigitId() {
            return Math.floor(1000000000 + Math.random() * 9000000000);
        }

        // Event delegation for copy, delete, radio, and checkbox actions
        document.getElementById('legs').addEventListener('click', function (e) {


            if (e.target.classList.contains('save-btn')) {
                const leg = e.target.closest('.legs-button');
                if (leg) {
                    // console.log("Saving data for",  leg.id.replace(/\D/g, ''));

                    const S_name = leg.querySelector(`#strategy-name-${leg.id.replace(/\D/g, '')}`);

                    if (S_name.value == "") {

                        alert("please input strategy name!");

                        return;
                    }
                    let r = check_s_name(S_name.value);
                    if (!r) {
                        alert("please input another name!");
                        return;
                    }
                    console.log(S_name.value)

                    const jsonData = saveLegsToJson2(leg.id.replace(/\D/g, ''), generate10DigitId());

                    console.log("Saved Legs Data:", jsonData);
                    // alert("Legs data saved! Check console for details.");

                    if (!jsonData) return;

                    const jsonObject = JSON.parse(jsonData);
                    console.log('jsonObject :', jsonObject);

                    // Prepare payload for Flask
                    const payload = {
                        user_id: userId ? userId : 1,  // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ID ‡¶¨‡¶∏‡¶æ‡¶ì
                        strategy_params: jsonObject
                    };

                    console.log("payload :", JSON.stringify(payload));

                    fetch("/save_strategy_params", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(payload)
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log("Server response:", data);
                            if (data.success) {
                                notify("s", "Strategy params saved successfully!");
                            } else {
                                notify("e", "Failed to save: " + data.msg);
                            }
                        })
                        .catch(err => console.error("Error:", err));



                }
            }
            if (e.target.classList.contains('deploy-btn')) {
                const leg = e.target.closest('.legs-button');
                if (leg) {
                    const S_name = leg.querySelector(`#strategy-name-${leg.id.replace(/\D/g, '')}`);

                    if (S_name.value == "") {

                        notify("w", "please input strategy name!");

                        return;
                    }
                    let r = check_s_name(S_name.value);
                    if (!r) {
                        notify("w", "please input another name!");
                        return;
                    }
                    const jsonData = saveLegsToJson2(leg.id.replace(/\D/g, ''));
                    console.log("Deployed Legs Data:", jsonData);
                    notify("s", "Legs data deployed! Check console for details.");
                }
            }


            if (e.target.classList.contains("add")) {
                const leg = e.target.closest('.legs-button');
                if (leg) {
                    a_condition++;
                    // ‡¶Ø‡ßá condition ‡¶è click ‡¶π‡¶≤ ‡¶§‡¶æ‡¶∞ parent clone ‡¶ï‡¶∞‡ßã
                    const condition = e.target.closest(".condition");
                    const clone = condition.cloneNode(true);
                    // console.log(clone)
                    const old_c_id = parseInt(condition.id.split("-").pop(), 10);

                    // ‡¶Ø‡ßá‡¶á container ‡¶è‡¶∞ ‡¶≠‡ßá‡¶§‡¶∞‡ßá ‡¶õ‡¶ø‡¶≤, ‡¶∏‡ßá‡¶ñ‡¶æ‡¶®‡ßá append ‡¶ï‡¶∞‡ßã
                    const container = e.target.closest(".field");
                    clone.id = `a-conditions-${a_condition}`;

                    // const advanced_conditions = clone.querySelectorAll(`#advanced-conditions-${oldLegId}`)

                    // clone ‡¶è‡¶∞ input / select clear ‡¶ï‡¶∞‡ßã
                    clone.querySelectorAll("input, select").forEach(el => el.value = "");

                    //    const trade_time = clone.querySelector(`#trade-time-${old_c_id}`);
                    //    if(trade_time) trade_time.id = `trade-time-${a_condition}`;

                    copySelectWithState(leg, clone, old_c_id, a_condition, "op");
                    copySelectWithState(leg, clone, old_c_id, a_condition, "op-s");
                    copySelectWithState(leg, clone, old_c_id, a_condition, "op-n");
                    copySelectWithState(leg, clone, old_c_id, a_condition, "op-s2");
                    copySelectWithState(leg, clone, old_c_id, a_condition, "trade-time");


                    // clone ‡¶ï‡ßá append ‡¶ï‡¶∞‡ßã parent container ‡¶è
                    container.appendChild(clone);

                    updateSelectedFromActiveLegs();
                }
            }




            if (e.target.classList.contains("remove")) {
                const condition = e.target.closest(".condition");
                // const container = document.getElementById("advanced-conditions");
                const container = e.target.closest(".field"); // fixed id ‡¶®‡¶æ, dynamic container ‡¶ß‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá

                // ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶è‡¶ï‡¶ü‡¶æ block ‡¶∏‡¶¨‡¶∏‡¶Æ‡ßü ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá
                if (container.querySelectorAll(".condition").length > 1) {
                    a_condition--;
                    condition.remove();
                }
                updateSelectedFromActiveLegs();
            }



            // Copy leg
            if (e.target.closest('.copy_leg')) {
                const leg = e.target.closest('.legs-button');
                if (leg) {
                    legCount++;
                    const oldLegId = leg.id.replace('leg', '');
                    const clone = leg.cloneNode(true);
                    clone.id = `leg${legCount}`;

                    // preserve "contact" select
                    copySelectWithState(leg, clone, oldLegId, legCount, "contact");
                    // copySelectWithState(leg, clone, oldLegId, legCount, "auto-e");

                    copySelectWithState(leg, clone, oldLegId, legCount, "op");
                    copySelectWithState(leg, clone, oldLegId, legCount, "op-s");
                    copySelectWithState(leg, clone, oldLegId, legCount, "op-n");
                    copySelectWithState(leg, clone, oldLegId, legCount, "op-s2");
                    copySelectWithState(leg, clone, oldLegId, legCount, "trade-time");


                    // Helper function to copy radio groups
                    // Use helper to copy radio groups
                    copyRadioGroup(leg, clone, `buy-sell-${oldLegId}`, `buy-sell-${legCount}`, legCount);
                    copyRadioGroup(leg, clone, `option-type-${oldLegId}`, `option-type-${legCount}`, legCount);
                    copyRadioGroup(leg, clone, `f-r-p-${oldLegId}`, `f-r-p-${legCount}`, legCount);
                    copyRadioGroup(leg, clone, `currency-type-${oldLegId}`, `currency-type-${legCount}`, legCount);
                    // copyRadioGroup(leg, clone, `auto-exit-${oldLegId}`, `auto-exit-${legCount}`, legCount);




                    // Update IDs for fields
                    // const mPriceField = clone.querySelector(`#m-price-${oldLegId}`);
                    const lPriceField = clone.querySelector(`#l-price-field-${oldLegId}`);
                    const lPrice_input = clone.querySelector(`#l-price-${oldLegId}`);

                    const lPriceToggle = clone.querySelector(`#l-price-toggle-${oldLegId}`);
                    const bestBidToggle = clone.querySelector(`#best-bid-toggle-${oldLegId}`);

                    const brocker_contact = clone.querySelector(`select[name^="brocker_contact-${oldLegId}"]`)

                    const qtyField = clone.querySelector(`.qty-${oldLegId}`);
                    const priceField = clone.querySelector(`.price-${oldLegId}`);
                    const leverageField = clone.querySelector(`#Leverage-${oldLegId}`);


                    // const contactField = clone.querySelector(`#contact-${oldLegId}`);


                    // Funding related fields
                    const fundingToggle = clone.querySelector(`#aExit-${oldLegId}`);
                    const fundingFields = clone.querySelector(`#funding-fields-${oldLegId}`);
                    const cpField = clone.querySelector(`#cp-${oldLegId}`);
                    const tpField = clone.querySelector(`#tp-${oldLegId}`);
                    const slField = clone.querySelector(`#sl-${oldLegId}`);
                    const tpFields = clone.querySelector(`#funding-fields-tp-${oldLegId}`);
                    const slFields = clone.querySelector(`#funding-fields-sl-${oldLegId}`);
                    const a_Controll = clone.querySelector(`#A-Controll-${oldLegId}`);
                    const f_r_p_type = clone.querySelector(`#f-r-p-type-${oldLegId}`);
                    // const trade_time = clone.querySelector(`#trade-time-${oldLegId}`);

                    const contact_details = clone.querySelector(`.contact_details-${oldLegId}`)

                    const deploy = clone.querySelector(`#deploy-${oldLegId}`);
                    const saveBtn = clone.querySelector(`#save-btn-${oldLegId}`);
                    const deployBtn = clone.querySelector(`#deploy-btn-${oldLegId}`);
                    const S_name = clone.querySelector(`#strategy-name-${oldLegId}`);


                    if (S_name) S_name.id = `strategy-name-${legCount}`;
                    if (deploy) deploy.id = `deploy-${legCount}`;
                    if (saveBtn) saveBtn.id = `save-btn-${legCount}`;
                    if (deployBtn) deployBtn.id = `deploy-btn-${legCount}`;
                    // if(trade_time) trade_time.id = `trade-time-${legCount}`;
                    if (f_r_p_type) f_r_p_type.id = `f-r-p-type-${legCount}`;


                    if (a_Controll) a_Controll.id = `A-Controll-${legCount}`;
                    if (tpField) tpField.id = `tp-${legCount}`;
                    if (slField) slField.id = `sl-${legCount}`;
                    if (fundingFields) fundingFields.id = `funding-fields-${legCount}`;
                    if (tpFields) tpFields.id = `funding-fields-tp-${legCount}`;
                    if (slFields) slFields.id = `funding-fields-sl-${legCount}`;
                    if (fundingToggle) fundingToggle.id = `aExit-${legCount}`;
                    if (cpField) cpField.id = `cp-${legCount}`;
                    if (leverageField) leverageField.id = `Leverage-${legCount}`;

                    // if (mPriceField) mPriceField.id = `m-price-${legCount}`;
                    // console.log("lPriceField :", lPriceField)

                    if (lPriceField) lPriceField.id = `l-price-field-${legCount}`;
                    if (lPrice_input) lPrice_input.id = `l-price-${legCount}`
                    if (lPriceToggle) lPriceToggle.id = `l-price-toggle-${legCount}`;
                    if (bestBidToggle) bestBidToggle.id = `best-bid-toggle-${legCount}`;

                    // console.log(legCount)

                    if (brocker_contact) brocker_contact.name = `brocker_contact-${legCount}`;



                    if (qtyField) qtyField.classList.replace(`qty-${oldLegId}`, `qty-${legCount}`)
                    if (priceField) priceField.classList.replace(`price-${oldLegId}`, `price-${legCount}`);
                    if (contact_details) contact_details.classList.replace(`contact_details-${oldLegId}`, `contact_details-${legCount}`);

                    // Update button classes,
                    clone.querySelector('.copy_leg').classList.replace(`leg${oldLegId}`, `leg${legCount}`);
                    clone.querySelector('.delete_leg').classList.replace(`leg${oldLegId}`, `leg${legCount}`);



                    // Update labels' for attributes
                    // const mPriceLabel = clone.querySelector(`label[for="m-price-${oldLegId}"]`);
                    const lPriceLabel = clone.querySelector(`label[for="l-price-label-${oldLegId}"]`);

                    // if (mPriceLabel) mPriceLabel.setAttribute('for', `m-price-${legCount}`);
                    if (lPriceLabel) lPriceLabel.setAttribute('for', `l-price-label-${legCount}`);



                    // Update visibility based on Market/Limit
                    const isMarket = clone.querySelector(`input[name="option-type-${legCount}"]:checked`).value === 'Market';
                    // if (mPriceField) mPriceField.style.display = isMarket ? '' : 'none';
                    if (lPriceField) lPriceField.style.display = isMarket ? 'none' : '';
                    if (lPriceToggle) lPriceToggle.style.display = isMarket ? 'none' : '';
                    if (bestBidToggle) lPriceField.style.display = bestBidToggle.checked ? 'none' : '';

                    document.getElementById('extra-legs').appendChild(clone);
                    updateTotalLegs();
                }
                updateSelectedFromActiveLegs();
            }

            // Delete leg
            if (e.target.closest('.delete_leg')) {
                const leg = e.target.closest('.legs-button');
                if (leg) leg.remove();
                updateTotalLegs();
            }

            // Handle Market/Limit radio toggle
            const limitRadio = e.target.closest('input[name^="option-type-"]');
            if (limitRadio) {
                const legContainer = limitRadio.closest('.legs-button');
                const legId = legContainer.id.replace('leg', '');
                const isMarket = limitRadio.value === 'Market';
                // const mPriceField = legContainer.querySelector(`#m-price-${legId}`);
                const lPriceField = legContainer.querySelector(`#l-price-field-${legId}`);
                const lPriceDiv = legContainer.querySelector(`#l-price-toggle-${legId}`);
                if (lPriceField && lPriceDiv) {
                    // mPriceField.style.display = isMarket ? '' : 'none';
                    lPriceField.style.display = isMarket ? 'none' : '';
                    lPriceDiv.style.display = isMarket ? 'none' : '';
                }
            }

            // Handle Best Bid checkbox
            const checkbox = e.target.closest('input[id^="best-bid-toggle-"]');
            if (checkbox) {
                const legContainer = checkbox.closest('.legs-button');
                const legId = legContainer.id.replace('leg', '');
                const lPriceField = legContainer.querySelector(`#l-price-field-${legId}`);
                if (lPriceField) {
                    // lPriceField.style.display = checkbox.checked ? 'none' : '';
                    Best_bid_toggle = checkbox.checked ? true : false;
                }
            }






            // Handle Funding checkbox
            const fundingCheckbox = e.target.closest('input[id^="aExit-"]');
            if (fundingCheckbox) {
                console.log(fundingCheckbox)

                const legContainer = fundingCheckbox.closest('.legs-button');
                const legId = legContainer.id.replace('leg', '');
                // const fundingFields = legContainer.querySelector(`#funding-fields-${legId}`);
                // const tpFields = legContainer.querySelector(`#funding-fields-tp-${legId}`);
                // const slFields = legContainer.querySelector(`#funding-fields-sl-${legId}`);
                const a_Controll = legContainer.querySelector(`#A-Controll-${legId}`);
                //  console.log('Funding checkbox toggled',a_Controll);
                if (a_Controll) {
                    a_Controll.style.display = fundingCheckbox.checked ? '' : 'none';
                }
            }

            // async function get_futures(contactField) {
            //     try {
            //         // const contactField = legContainer.querySelector(`#contact-${legId}`);
            //         // console.log(contactField)

            //         const res = await fetch(APP_URL + "/funding?token=" + token + "&funding=true");
            //         if (!res.ok) throw new Error("Unauthorized or fetch error");
            //         const data = await res.json();
            //         // console.log(data)
            //         // funding_data = data;
            //         // localStorage.setItem("fundingData", JSON.stringify(funding_data)); // save
            //         // Populate dropdown only once (avoid duplicates)

            //         // console.log(contactField.options.length)

            //         if (contactField.options.length <= 2) {
            //             for (const symbol of Object.keys(data)) {
            //                 const opt = document.createElement("option");
            //                 opt.value = symbol;
            //                 opt.textContent = symbol;
            //                 contactField.appendChild(opt);
            //             }
            //         }
            //     } catch (err) {
            //         console.error("Error fetching futures:", err);
            //     }
            // }


            // ‡¶∏‡¶¨ radio button select ‡¶ï‡¶∞‡ßã
            const radios = e.target.closest('input[name^="f-r-p-"]');
            if (radios) {
                const legContainer = radios.closest('.legs-button');
                const legId = legContainer.id.replace('leg', '');
                // console.log(radios.value)
                // change event listener ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßã
                add_renderFunding(legId, "M-f");
            }



            const contact_select = e.target.closest('select[id^="contact-"]');

            if (contact_select) {

                const legContainer = contact_select.closest('.legs-button');
                const legId = legContainer.id.replace('leg', '');
                const contactField = legContainer.querySelector(`#contact-${legId}`);
                const frptype = legContainer.querySelector(`#f-r-p-type-${legId}`);
                const contact_details = legContainer.querySelector(`.contact_details-${legId}`);
                // console.log(contact_details)
                if (contactField) {

                    const prevSelected = contactField.value;

                    while (contactField.options.length > 2) {
                        contactField.remove(2);
                    }

                    for (const symbol of Object.keys(funding_data)) {
                        // console.log("symbol :", symbol)
                        const opt = document.createElement("option");
                        opt.value = symbol;
                        opt.id = all_tickers_data[symbol]?.product_id || "";
                        opt.textContent = symbol;

                        if (symbol === prevSelected) opt.selected = true;
                        contactField.appendChild(opt);
                    }

                    const sym = contactField.value;
                    if (sym) add_renderFunding(legId, sym);

                    frptype.style.display = contactField.selectedIndex === 1 ? '' : 'none';
                }

            }

            // console.log(contactField)

            const op = e.target.closest('select[id^="op-"]');
            if (op) {
                // console.log(op.id);
                const legContainer = op.closest('.condition');
                // const legId = legContainer.id.replace('leg', '');
                // const legId = a_condition;
                // const legId = parseInt(legContainer.id.split("-").pop(), 10);
                const legId = parseInt(op.id.match(/\d+$/)[0], 10)
                // console.log("legId : ",legId)
                const opindex = legContainer.querySelector(`#op-${legId}`);
                const trade_time = legContainer.querySelector(`#trade-time-${legId}`);
                const op_n = legContainer.querySelector(`#op-n-${legId}`);
                if (opindex) {
                    // console.log(opindex.selectedIndex);
                    // contactField.selectedIndex = contact_select.selectedIndex;

                    trade_time.style.display = opindex.selectedIndex === 1 ? '' : 'none';
                    // trade_time.value = opindex.selectedIndex === 1 ? '09:00' : '00:00';
                    op_n.style.display = opindex.selectedIndex === 1 ? 'none' : '';

                }
            }


        });




        function copySelectWithState(origLeg, cloneLeg, oldLegId, newLegId, baseId) {
            const origSelect = origLeg.querySelector(`#${baseId}-${oldLegId}`);
            if (!origSelect) return;

            // remember the selected option
            const selectedIndex = origSelect.selectedIndex;

            // find the select inside the clone (still has old id for now)
            const cloneSelect = cloneLeg.querySelector(`#${baseId}-${oldLegId}`);
            if (!cloneSelect) return;

            // apply the original selection
            cloneSelect.selectedIndex = selectedIndex;

            // then rename id/name for the clone
            cloneSelect.id = `${baseId}-${newLegId}`;
            cloneSelect.name = `${baseId}-${newLegId}`;
            // console.log(`Copied select ${baseId} from leg${oldLegId} to leg${newLegId}`);
        }

        // helper to copy radio-group inputs from original leg to clone
        function copyRadioGroup(legEl, cloneEl, oldGroupName, newGroupName, legCount) {
            const orig = legEl.querySelectorAll(`input[name="${oldGroupName}"]`);
            const cloned = cloneEl.querySelectorAll(`input[name="${oldGroupName}"]`);
            orig.forEach((origInput, i) => {


                const c = cloned[i];
                if (!c) return; // safety
                // set new name and preserve checked state
                c.name = newGroupName;
                c.checked = origInput.checked;
                // keep defaultChecked in sync so resets behave the same
                c.defaultChecked = origInput.defaultChecked;
            });
        }


        function toggleBrocker_selected() {
            const brokerSelect = document.querySelector('#Brocker select');
            brokerSelect.addEventListener("change", () => {
                const option = brokerSelect.options[brokerSelect.selectedIndex];

                if (option.value == "Dcx") {
                    console.log("Broker value:", option.value);

                } else {
                    console.log("Broker value:", option.value);
                }
            });
        }
        toggleBrocker_selected();


        function toggleBroker() {
            const orderRadios = document.querySelectorAll('input[name="order"]');
            const brokerField = document.getElementById("Brocker");

            let selected = document.querySelector('input[name="order"]:checked').value;

            if (selected === "FUTURE") {
                brokerField.style.display = "block";
            } else {
                brokerField.style.display = "none";
            }

            // on change
            orderRadios.forEach(radio => {
                radio.addEventListener("change", toggleBroker);
            });

            toggleBrokerContactFields(selected)
        }

        // initial load
        toggleBroker();


        function toggleBrokerContactFields(selected) {
            // ARBITRAGE radio checked ‡¶ï‡¶ø‡¶®‡¶æ
            const isFutureArbitrageSelected = selected != "FUTURE";
            // document.querySelector('input[name="order"][value="ARBITRAGE"]')?.checked;

            // brocker_contact-* ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶¨ select ‡¶ß‡¶∞‡¶õ‡¶ø
            document
                .querySelectorAll('select[name^="brocker_contact-"]')
                .forEach(select => {
                    // select-‡¶è‡¶∞ parent div (.field)
                    const fieldDiv = select.closest('.field');

                    if (fieldDiv) {
                        fieldDiv.style.display = isFutureArbitrageSelected ? 'inline-block' : 'none';
                    }
                });
        }


        // Add event listeners to the "order" radio buttons
        // document.querySelectorAll('input[name="order"]').forEach(radio => {
        //     radio.addEventListener('change', toggleBrokerContactFields);
        // });

        // Call the function on page load to set the initial state
        // toggleBrokerContactFields();



        // Timing ON/OFF toggle show/hide time fields
        function updateTimingFields() {
            const isOn = document.querySelector('input[name="toggle"][value="on"]').checked;
            document.getElementById('timing-fields').style.display = isOn ? '' : 'none';
        }
        document.querySelectorAll('input[name="toggle"]').forEach(radio => {
            radio.addEventListener('change', updateTimingFields);
        });
        updateTimingFields();



        // Toggle active class for days
        document.querySelectorAll(".days button").forEach(btn => {
            btn.addEventListener("click", () => {
                btn.classList.toggle("active");
            });
        });

        // Save Legs as JSON
        document.addEventListener('DOMContentLoaded', () => {
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save Legs as JSON';
            saveButton.style = `
                background: #28a745;
                color: #fff;
                border: none;
                border-radius: 20px;
                padding: 8px 20px;
                font-size: 15px;
                cursor: pointer;
                margin-top: 20px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            `;
            document.getElementById('legs').appendChild(saveButton);

            saveButton.addEventListener('click', () => {
                const jsonData = saveLegsToJson();
                console.log(jsonData);

                // Download JSON as a file
                // const blob = new Blob([jsonData], { type: 'application/json' });
                // const url = URL.createObjectURL(blob);
                // const a = document.createElement('a');
                // a.href = url;
                // a.download = 'legs_data.json';
                // a.click();
                // URL.revokeObjectURL(url);
            });
        });
    </script>








    <script>
        function change_layout(layout_name, Button) {
            // console.log("layout_name:", layout_name);
            var layouts = document.getElementsByClassName("layout_strategy");

            // ‡¶è‡¶ñ‡¶® ‡¶Ø‡ßá‡¶ü‡¶æ layout_name ‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Æ‡ßá‡¶≤‡ßá ‡¶∏‡ßá‡¶ü‡¶æ show ‡¶ï‡¶∞‡ßã
            Array.from(layouts).forEach(layout => {
                // console.log(layout.classList[0]);

                if (layout.classList.value.includes(layout_name)) {
                    // if (layout.classList.contains(layout_name)) {
                    layout.style.display = "block";
                    //   layout.style.visibility = "visible";
                    // console.log("Show:", layout.classList.value);
                } else {
                    layout.style.display = "none";
                    //   layout.style.visibility = "visible";
                    // console.log("Hide:", layout.classList.value);
                }
            });
        }









        // const userId = 1; // Example user_id
        // const statusDiv = document.getElementById("strategy-status");

        // // Function to fetch full strategy status and update the div
        // async function updateStrategyStatus() {
        //     try {
        //         const res = await fetch(`http://localhost:5000/get_user_full_status?user_id=${userId}`);
        //         const data = await res.json();

        //         // console.log("data :", data)
        //         if (data.success) {
        //             const status = data.data;

        //             // Create HTML content
        //             let html = `<h3>Strategy Status</h3>`;
        //             html += `
        //                 <button onclick="controlStrategy('start')" style="background:#0066ff;color:#fff;border:none;border-radius:10px;padding:6px 18px;margin-right:10px;cursor:pointer;">Start</button>
        //                 <button onclick="controlStrategy('stop')" style="background:#d32f2f;color:#fff;border:none;border-radius:10px;padding:6px 18px;cursor:pointer;">Stop</button>
        //             `;
        //             html += `<p><strong>Running:</strong> <span style="color:blue;">${status.running}</span></p>`;
        //             html += `<p><strong>Last Signal:</strong> ${status.last_signal}</p>`;
        //             html += `<p ><strong>PNL:</strong> <span style="color:green;">${status.pnl.toFixed(2)}</span></p>`;

        //             // Positions
        //             html += `<h4>Positions:</h4>`;
        //             if (status.positions.length === 0) {
        //                 html += `<p>No positions</p>`;
        //             } else {
        //                 html += `<ul>`;
        //                 status.positions.forEach(pos => {
        //                     html += `<li>${pos.side} @ <span style="color:green;">${pos.price}</span> : ${pos.timestamp} </li>`;
        //                 });
        //                 html += `</ul>`;
        //             }

        //             // Strategy Legs
        //             html += `<h4>Strategy Legs:</h4>`;
        //             if (status.strategy_params.length === 0) {
        //                 html += `<p>No legs created</p>`;
        //             } else {
        //                 status.strategy_params.forEach(leg => {
        //                     html += `<div style="border:1px solid #ccc; margin:5px; padding:5px;">
        //                         <p><strong>Leg ID:</strong> ${leg.legId}</p>
        //                         <p><strong>Strategy Name:</strong> ${leg.Sname}</p>
        //                         <p><strong>Buy/Sell:</strong> ${leg.buySell}</p>
        //                         <p><strong>Type:</strong> ${leg.type}</p>
        //                         <p><strong>Price:</strong> ${leg.price}</p>
        //                         <p><strong>Qty:</strong> ${leg.qty}</p>
        //                         <p><strong>Leverage:</strong> ${leg.leverage}</p>
        //                      </div>`;
        //                 });
        //             }

        //             statusDiv.innerHTML = html;
        //         } else {
        //             statusDiv.innerHTML = `<p>Error: ${data.msg}</p>`;
        //         }
        //     } catch (err) {
        //         console.error(err);
        //         statusDiv.innerHTML = `<p>Error fetching data</p>`;
        //     }
        // }

        // // Call immediately and then every 10 seconds
        // updateStrategyStatus();
        // setInterval(updateStrategyStatus, 1000);









        // const userId = 1; // Example user_id
        // const statusDiv = document.getElementById("strategy-status");

        // // Function to fetch full strategy status and update the div
        // async function updateStrategyStatus() {
        //     try {
        //         const res = await fetch(`http://localhost:5000/get_user_full_status?user_id=${userId}`);
        //         const data = await res.json();

        //         // Create HTML content
        //         let html = `<h3>Strategy Status</h3>`;
        //         html += `
        //     <button onclick="controlStrategy('start')" style="background:#0066ff;color:#fff;border:none;border-radius:10px;padding:6px 18px;margin-right:10px;cursor:pointer;">Start</button>
        //     <button onclick="controlStrategy('stop')" style="background:#d32f2f;color:#fff;border:none;border-radius:10px;padding:6px 18px;cursor:pointer;">Stop</button>
        // `;

        //         html += `<p><strong>Running:</strong> <span style="color:${data.running ? 'green' : 'red'};">${data.running}</span></p>`;
        //         html += `<p><strong>Last Signal:</strong> ${data.last_signal}</p>`;
        //         html += `<p><strong>PNL:</strong> <span style="color:${data.pnl >= 0 ? 'green' : 'red'};">${data.pnl.toFixed(2)}</span></p>`;
        //         const pnlValue = (typeof data.pnl === "number" && !isNaN(data.pnl)) ? data.pnl.toFixed(2) : "0.00";
        //         html += `<p><strong>PNL:</strong> <span style="color:${data.pnl >= 0 ? 'green' : 'red'};">${pnlValue}</span></p>`;


        //         // Positions
        //         html += `<h4>Positions:</h4>`;
        //         if (!data.positions || data.positions.length === 0) {
        //             html += `<p>No positions</p>`;
        //         } else {
        //             html += `<ul>`;
        //             data.positions.forEach(pos => {
        //                 html += `<li>${pos.side} @ <span style="color:green;">${pos.entry_price}</span> (${pos.contact}) ‚Äî ${new Date(pos.timestamp).toLocaleTimeString()}</li>`;
        //             });
        //             html += `</ul>`;
        //         }

        //         // Strategy Legs
        //         html += `<h4>Strategy Legs:</h4>`;
        //         if (!data.strategy_params || data.strategy_params.length === 0) {
        //             html += `<p>No legs created</p>`;
        //         } else {
        //             data.strategy_params.forEach(leg => {
        //                 html += `<div style="border:1px solid #ccc; border-radius:10px; margin:5px; padding:8px;">
        //             <p><strong>Leg ID:</strong> ${leg.legId}</p>
        //             <p><strong>Name:</strong> ${leg.Sname}</p>
        //             <p><strong>Buy/Sell:</strong> ${leg.buySell}</p>
        //             <p><strong>Type:</strong> ${leg.type}</p>
        //             <p><strong>Price:</strong> ${leg.price}</p>
        //             <p><strong>Qty:</strong> ${leg.qty}</p>
        //             <p><strong>Leverage:</strong> ${leg.leverage}</p>
        //         </div>`;
        //             });
        //         }

        //         statusDiv.innerHTML = html;
        //     } catch (err) {
        //         console.error("Fetch error:", err);
        //         statusDiv.innerHTML = `<p style="color:red;">Error fetching strategy status</p>`;
        //     }
        // }

        // // Control start/stop strategy
        // async function controlStrategy(action) {
        //     try {
        //         const res = await fetch("http://localhost:5000/control", {
        //             method: "POST",
        //             headers: { "Content-Type": "application/json" },
        //             body: JSON.stringify({ user_id: userId, action })
        //         });
        //         const data = await res.json();
        //         alert(data.msg || "Action complete");
        //         updateStrategyStatus(); // refresh immediately after start/stop
        //     } catch (err) {
        //         console.error("Control error:", err);
        //         alert("Error controlling strategy");
        //     }
        // }

        // // Initial call + repeat every 10 sec
        // updateStrategyStatus();
        // setInterval(updateStrategyStatus, 2000);









        // async function controlStrategy(action) {
        //     const res = await fetch("http://localhost:5000/control", {
        //         method: "POST",
        //         headers: { "Content-Type": "application/json" },
        //         body: JSON.stringify({
        //             user_id: 1,
        //             action: action
        //         })
        //     });
        //     const data = await res.json();
        //     console.log(data.msg);
        // }


    </script>





    <script>
        // const userId = 1;
        // const userId = JSON.parse(localStorage.getItem("user_id") || "");
        const userId = JSON.parse(localStorage.getItem("user_id") || "1");



        const runningStatusSpan = document.getElementById("running-status");
        const lastSignalSpan = document.getElementById("last-signal");
        const pnlValueSpan = document.getElementById("pnl-value");
        const positionsUl = document.getElementById("positions");
        const legsDiv = document.getElementById("my_legs");

        document.getElementById("start-btn").addEventListener("click", () => controlStrategy('start'));
        document.getElementById("stop-btn").addEventListener("click", () => controlStrategy('stop'));


        const advancedOpenState = {};

        async function updateStrategyStatus() {
            try {
                const res = await fetch(`/get_user_full_status?user_id=${userId}`);
                const resp = await res.json();

                if (!resp.success) {
                    notify("e", `Error: ${resp.msg}`);
                    return;
                }

                const data = resp.data;
                // console.log(data);

                // Update top info
                runningStatusSpan.textContent = data.running ? "Yes" : "No";
                runningStatusSpan.style.color = data.running ? "green" : "red";
                lastSignalSpan.textContent = data.last_signal || "NONE";

                const pnlValue = (typeof data.pnl === "number" && !isNaN(data.pnl)) ? data.pnl.toFixed(2) : "0.00";
                pnlValueSpan.textContent = pnlValue;
                pnlValueSpan.style.color = data.pnl >= 0 ? "green" : "red";

                // console.log("pnlValue :"+pnlValue);

                // Update positions
                positionsUl.innerHTML = "";
                if (!data.positions || data.positions.length === 0) {
                    const li = document.createElement("li");
                    li.textContent = "No positions";
                    positionsUl.appendChild(li);
                } else {
                    data.positions.forEach(pos => {
                        const li = document.createElement("li");
                        const price = pos.entry_price || pos.price || "0";
                        const ts = pos.timestamp ? new Date(pos.timestamp).toLocaleTimeString() : "-";
                        const contact = pos.contact || "-";
                        const broker = pos.broker || ""
                        li.innerHTML = `${pos.side || "NONE"} @ <a style="color:green;">${broker}</a> @ <span style="color:green;">${price}</span> (${contact}) ‚Äî ${ts}`;
                        positionsUl.appendChild(li);
                    });
                }

                // Update strategy legs
                legsDiv.innerHTML = "";
                if (!data.strategy_params || data.strategy_params.length === 0) {
                    legsDiv.textContent = "No legs created";
                } else {

                    // data.strategy_params.forEach(leg => {
                    data.strategy_params.forEach((leg, index) => {

                        const div = document.createElement("div");
                        const sideClass = leg.buySell === "BUY" ? "side-buy" : "side-sell";
                        div.className = "leg-box";

                        const Brocker = leg.Brocker;
                        if (Brocker) {
                            div.innerHTML = `<b><div style="color:blue;position:relative">${Brocker}</div></b><br>`;
                        }
                        div.innerHTML += `
        <div class="leg-top">
            <div class="${sideClass}">${leg.buySell}</div>
            <div>${leg.contact} (${leg.type})</div>
        </div>

        <div class="leg-meta">
            Leg: ${leg.legId} | Name: ${leg.Sname}
        </div>

        <div class="leg-grid">
            <div><b>Price</b><br>${leg.price}</div>
            <div><b>Qty</b><br>${leg.qty}</div>
            <div><b>Lev</b><br>${leg.leverage}x</div>
        </div>

        <div class="adv-section">
            <div class="adv-title">Execution</div>
            <div class="adv-row"><span>bestBid</span><span>${leg.bestBid ? "Yes" : "No"}</span></div>
            <div class="adv-row"><span>frp</span><span>${leg.frp || "-"}</span></div>

            <div class="adv-title">Risk</div>
            <div class="adv-row"><span>SL</span><span>${leg.sl || "-"}</span></div>
            <div class="adv-row"><span>TP</span><span>${leg.tp || "-"}</span></div>
            <div class="adv-row"><span>Auto Exit</span><span>${leg.aExit ? "Enabled" : "Disabled"}</span></div>

            <div class="adv-title">System</div>
            <div class="adv-row"><span>productId</span><span>${leg.productId}</span></div>
            <div class="adv-row"><span>cp</span><span>${leg.cp || "-"}</span></div>
            <div class="adv-row"><span>lPrice</span><span>${leg.lPrice || "-"}</span></div>

            <pre>${JSON.stringify(leg.advanced || {}, null, 2)}</pre>
        </div>

        <div class="leg-actions">
            <button class="btn btn-adv">Show Advanced</button>
            <button class="btn btn-remove">Remove</button>
        </div>
    `;

                        const adv = div.querySelector(".adv-section");
                        const advBtn = div.querySelector(".btn-adv");

                        // const isOpen = advancedOpenState[leg.id] === true;
                        const isOpen = advancedOpenState[index] === true;

                        adv.style.display = isOpen ? "block" : "none";
                        advBtn.innerText = isOpen ? "Hide Advanced" : "Show Advanced";

                        advBtn.onclick = () => {
                            const newState = adv.style.display !== "block";
                            adv.style.display = newState ? "block" : "none";
                            advBtn.innerText = newState ? "Hide Advanced" : "Show Advanced";
                            advancedOpenState[index] = newState;
                        };


                        // const adv = div.querySelector(".adv-section");
                        // adv.style.display = "none";

                        // const advBtn = div.querySelector(".btn-adv");
                        // advBtn.onclick = () => {
                        //     const open = adv.style.display === "block";
                        //     adv.style.display = open ? "none" : "block";
                        //     advBtn.innerText = open ? "Show Advanced" : "Hide Advanced";
                        // };

                        const removeBtn = div.querySelector(".btn-remove");
                        if (data.running) {
                            removeBtn.disabled = true;
                            removeBtn.style.opacity = "0.5";
                            removeBtn.style.cursor = "not-allowed";
                            removeBtn.title = "Stop strategy to remove leg";
                        } else {
                            removeBtn.onclick = () => removeLeg(leg.id, leg.Sname, index);
                        }

                        legsDiv.appendChild(div);
                    });

                }

            } catch (err) {
                console.error("Fetch error:", err);
            }
        }

        async function removeLeg(id, Sname, index) {
            console.log(index)
            if (!confirm(`Are you sure you want to remove leg ${Sname}?`)) return;

            try {
                const res = await fetch("/remove_leg", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId, id: id, name: Sname })
                });
                const data = await res.json();
                console.log(data.msg || "Leg removed");
                notify("s", "Leg removed");
                updateStrategyStatus(); // Refresh after removal
            } catch (err) {
                console.error("Remove leg error:", err);
                notify("e", "Error removing leg");
            }
        }

        // Control start/stop strategy
        async function controlStrategy(action) {
            try {
                const res = await fetch("/control", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId, action })
                });
                const data = await res.json();
                console.log(data);
                notify("w", data.msg || "Action complete");
                updateStrategyStatus(); // refresh immediately after start/stop
            } catch (err) {
                console.error("Control error:", err);
                alert("Error controlling strategy");
            }
        }

        // // Initial call + repeat every 5 seconds
        // updateStrategyStatus();
        // setInterval(updateStrategyStatus, 5000);
    </script>






    <!-- <script>
        const userId = 1; // Example user_id
        const statusDiv = document.getElementById("strategy-status");

        // Function to fetch full strategy status and update the div
        async function updateStrategyStatus() {
            try {
                const res = await fetch(`http://localhost:5000/get_user_full_status?user_id=${userId}`);
                const resp = await res.json();

                if (!resp.success) {
                    statusDiv.innerHTML = `<p style="color:red;">Error: ${resp.msg}</p>`;
                    return;
                }

                const data = resp.data;

                let html = `<h3>Strategy Status</h3>`;
                html += `
<button type="button" onclick="controlStrategy('start')" style="background:#0066ff;color:#fff;border:none;border-radius:10px;padding:6px 18px;margin-right:10px;cursor:pointer;">Start</button>
<button type="button" onclick="controlStrategy('stop')" style="background:#d32f2f;color:#fff;border:none;border-radius:10px;padding:6px 18px;cursor:pointer;">Stop</button>
`;

                const runningStatus = data.running ? "Yes" : "No";
                html += `<p><strong>Running:</strong> <span style="color:${data.running ? 'green' : 'red'};">${runningStatus}</span></p>`;

                html += `<p><strong>Last Signal:</strong> ${data.last_signal || "NONE"}</p>`;

                const pnlValue = (typeof data.pnl === "number" && !isNaN(data.pnl)) ? data.pnl.toFixed(2) : "0.00";
                html += `<p><strong>PNL:</strong> <span style="color:${data.pnl >= 0 ? 'green' : 'red'};">${pnlValue}</span></p>`;

                // Positions
                html += `<h4>Positions:</h4>`;
                if (!data.positions || data.positions.length === 0) {
                    html += `<p>No positions</p>`;
                } else {
                    html += `<ul>`;
                    data.positions.forEach(pos => {
                        const price = pos.entry_price || pos.price || "0";
                        const ts = pos.timestamp ? new Date(pos.timestamp).toLocaleTimeString() : "-";
                        const contact = pos.contact || "-";
                        html += `<li>${pos.side || "NONE"} @ <span style="color:green;">${price}</span> (${contact}) ‚Äî ${ts}</li>`;
                    });
                    html += `</ul>`;
                }

                // Strategy Legs
                html += `<h4>Strategy Legs:</h4>`;
                if (!data.strategy_params || data.strategy_params.length === 0) {
                    html += `<p>No legs created</p>`;
                } else {
                    data.strategy_params.forEach(leg => {
                        html += `<div style="border:1px solid #ccc; border-radius:10px; margin:5px; padding:8px;">
                    <p><strong>Leg ID:</strong> ${leg.legId || "-"}</p>
                    <p><strong>Name:</strong> ${leg.Sname || "-"}</p>
                    <p><strong>Buy/Sell:</strong> ${leg.buySell || "-"}</p>
                    <p><strong>Type:</strong> ${leg.type || "-"}</p>
                    <p><strong>Price:</strong> ${leg.price || "0"}</p>
                    <p><strong>Qty:</strong> ${leg.qty || "0"}</p>
                    <p><strong>Leverage:</strong> ${leg.leverage || "0"}</p>
                    <button type="button" onclick="removeLeg('${leg.legId}')" style="background:#d32f2f;color:#fff;border:none;border-radius:6px;padding:4px 10px;margin-top:5px;cursor:pointer;">Remove Leg</button>
                </div>`;
                    });
                }

                statusDiv.innerHTML = html;

            } catch (err) {
                console.error("Fetch error:", err);
                statusDiv.innerHTML = `<p style="color:red;">Error fetching strategy status</p>`;
            }
        }

        async function removeLeg(legId) {
            if (!confirm(`Are you sure you want to remove leg ${legId}?`)) return;

            try {
                const res = await fetch("http://localhost:5000/remove_leg", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId, leg_id: legId })
                });
                const data = await res.json();
                alert(data.msg || "Leg removed");
                updateStrategyStatus(); // Refresh after removal
            } catch (err) {
                console.error("Remove leg error:", err);
                alert("Error removing leg");
            }
        }


        // Control start/stop strategy
        async function controlStrategy(action) {
            try {
                const res = await fetch("http://localhost:5000/control", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId, action })
                });
                const data = await res.json();
                alert(data.msg || "Action complete");
                updateStrategyStatus(); // refresh immediately after start/stop
            } catch (err) {
                console.error("Control error:", err);
                alert("Error controlling strategy");
            }
        }

        // Initial call + repeat every 10 seconds
        updateStrategyStatus();
        setInterval(updateStrategyStatus, 1000);
    </script> -->


    <!-- Notification Area -->
    <div id="notifyArea" class="notify-area"></div>
    <script>
        function notify(type, message, timeout = 4000) {
            let title = "";   // ‚úÖ FIX: declare first
            if (type == "i") {
                type = "info";
                title = "info";
            } else if (type == "s") {
                type = "success";
                title = "success";
            } else if (type == "w") {
                type = "warn";
                title = "warning";
            } else if (type == "e") {
                type = "error";
                title = "error";
            }
            const area = document.getElementById('notifyArea');
            const icons = { info: '‚ÑπÔ∏è', success: '‚úÖ', warn: '‚ö†Ô∏è', error: '‚ùå' };
            //  console.log(icons[type])
            const note = document.createElement('div');
            note.className = `notify ${type}`;
            note.innerHTML = `
    <div class="notify-content">
      <div style="line-height: 1; font-size:20px;">${icons[type]}</div>
      <div>
      <div class="notify-header">${title}</div>
      <div class="notify-body">${message}</div>
      </div>
    </div>
    <button class="close-btn">&times;</button>
  `;

            area.appendChild(note);

            // Show animation
            requestAnimationFrame(() => note.classList.add('show'));

            // Close button
            note.querySelector('.close-btn').onclick = () => removeNote();

            //   Auto-remove
            const timer = setTimeout(removeNote, timeout);

            function removeNote() {
                note.classList.remove('show');
                clearTimeout(timer);
                setTimeout(() => note.remove(), 300);
            }
        }
    </script>






    <script>
        token = "3d2a1b4e1bc806605237d663b4e76a0e";


        function formatPrice(num) {
            num = Number(num);

            if (num >= 1) {
                return parseFloat(num.toFixed(2));
            } else {
                return parseFloat(num.toFixed(5));
            }
        }



        // let funding_data = JSON.parse(localStorage.getItem("fundingData") || "{}");
        // let selected = JSON.parse(localStorage.getItem("selectedSymbols") || "[]");

        // let all_tickers_data = [];
        let rander_funding_condition = false;


        intervals = [];
        let isRunning = false;


        /////////////////////////////////////////////////////////////
        //update marquee..

        // üîÅ Update marquee every 2 seconds
        async function updateMarquee() {
            // const tickers = ["BTCUSD", "ETHUSD", "SOLUSD", "ADAUSD", "XRPUSD", "AIAUSD", "1MBABYDOGEUSD"]; // add your symbols

            const data = await get_tickers();
            if (!data) return;
            // console.log(data);
            all_tickers_data = data;

            // console.log(all_tickers_data["BTCUSD"]);


            const marquee = document.getElementById("crypto-marquee");
            marquee.innerHTML = ""; // clear old data

            // loop through all coins
            Object.entries(data).forEach(([symbol, info]) => {
                // const tickers = data[symbol];
                // console.log("symbol :" + symbol)
                // console.log("info :" + info)
                const change = parseFloat(info.mark_change_24h);

                let price = 0;
                if (marquee.classList.contains("show-funding")) {
                    price = parseFloat(info.funding_rate).toFixed(4);
                    // console.log("funding_rate :" + price)
                } else {
                    price = parseFloat(info.mark_price).toFixed(4);
                    // console.log("mark_price :" + price)
                }

                // const price = parseFloat(info.mark_price).toFixed(4);

                // console.log("price :" + price)

                const up = change >= 0;

                const span = document.createElement("span");
                span.className = "crypto-item";
                span.style.marginRight = "40px";

                span.innerHTML = `
            ${symbol}
            <span class="${up ? 'up' : 'down'}">
                ${up ? '+' : ''}${(change).toFixed(3)}%
            </span>
            <span class="crypto-price">${price}</span>
        `;

                marquee.appendChild(span);
            });
        }


        //tickers..

        async function get_tickers(tickers = []) {
            // if (tickers.length === 0) {
            //     console.warn("‚ö†Ô∏è No tickers provided!");
            //     return null;
            // }

            try {

                const brokerSelect = document.querySelector('#Brocker select');
                const option = brokerSelect.options[brokerSelect.selectedIndex];
                let data = "";

                const symbolsParam = JSON.stringify(tickers);
                const url = `/tickers?tickers=true&symbols=${encodeURIComponent(symbolsParam)}`;

                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                data = await res.json();

                // console.log("data :", data)
                // const data = await res.json();
                return data; // ‚úÖ return data instead of console.log
            } catch (err) {
                console.error("‚ùå Error fetching tickers:", err);
                return null;
            }
        }




        // async function updata_tickers_dcx(tickers = []) {
        //     try {
        //         // if (!tickers.length) return {};

        //         // üî• clean symbols
        //         const cleanTickers = selected.filter(
        //             s => typeof s === "string" && s.trim() !== ""
        //         );

        //         const symbolsParam = JSON.stringify(cleanTickers);
        //         const url =
        //             APP_URL +
        //             `/tickers?tickers_dcx=true&symbols=${encodeURIComponent(symbolsParam)}`;

        //         const res = await fetch(url);
        //         if (!res.ok) throw new Error(`DCX HTTP ${res.status}`);

        //         all_tickers_data_dcx = await res.json();
        //         // return all_tickers_data_dcx;


        //     } catch (err) {
        //         console.error("‚ùå DCX ticker error:", err);
        //         // return {};
        //     }
        // }



        async function updata_tickers_dcx() {
            try {
                const selectedObj = getSelected(); // {1:"ADAUSD",3:"ADAUSD"}

                // üî• Object ‚Üí Array
                const cleanTickers = Object.values(selectedObj).filter(
                    s => typeof s === "string" && s.trim() !== ""
                );

                if (!cleanTickers.length) return;

                const symbolsParam = JSON.stringify(cleanTickers);
                const url =
                    `/tickers?tickers_dcx=true&symbols=${encodeURIComponent(symbolsParam)}`;

                const res = await fetch(url);
                if (!res.ok) throw new Error(`DCX HTTP ${res.status}`);

                all_tickers_data_dcx = await res.json();

            } catch (err) {
                console.error("‚ùå DCX ticker error:", err);
            }
        }






        // ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£:
        // get_tickers(["BTCUSD", "ETHUSD"]);


        //orders...

        async function get_active_order() {
            try {
                const res = await fetch("/v2/positions/margined?orders=true&token=" + token);
                if (!res.ok) throw new Error("Unauthorized or fetch error");
                const data = await res.json();

                // console.log("orders", data);

                // if (Object.keys(data.orders).length === 0 || !Object.keys(data.orders)) {
                //     document.querySelector(".active_order_position").innerHTML = "<p>No open orders.</p>";
                //     return;
                // }

                if (!data.orders || Object.keys(data.orders).length === 0) {
                    document.querySelector(".active_order_position").innerHTML = "<p>No open orders.</p>";
                    return;
                }

                let html = "<table border='1|1'>";
                html += "<tr><th>Symbol</th><th>limit_price</th><th>order_type</th><th>side</th><th>size</th><th>state</th><th>reduce_only</th><th>date</th></tr>";
                Object.entries(data.orders).forEach(entry => {
                    const pos = entry[1];
                    // console.log(pos)

                    // Set quantity or process positions
                    const date = new Date(pos.updated_at);
                    // Format date to "22 Oct 8:05:02 PM" style
                    const formattedDate = date.toLocaleString('en-US', {
                        day: '2-digit',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true,
                        timeZone: 'Asia/Kolkata' // IST
                    }).replace(/,/, ''); // Remove comma if present


                    html += `<tr>
                    <td>${pos.product_symbol}</td>
                    <td>${pos.limit_price}</td>
                    <td>${pos.order_type}</td>
                    <td>${pos.side}</td>
                    <td>${pos.size}</td>
                    <td>${pos.state}</td>
                    <td>${pos.reduce_only}</td>
                    <td>${formattedDate}</td>
                        `;
                });
                html += "</table>";
                document.querySelector(".active_order_position").innerHTML = html;

            } catch (error) {

            }
        }






        // positions...
        //     async function get_positions() {
        //         try {
        //             const res = await fetch(APP_URL + "/v2/positions/margined?positions=true&token=" + token);
        //             if (!res.ok) throw new Error("Unauthorized or fetch error");
        //             const data = await res.json();


        //             // console.log("Positions", data.positions);


        //             // if (Object.keys(data.positions).length === 0 || !Object.keys(data.positions)) {
        //             //     document.querySelector(".position").innerHTML = "<p>No open positions.</p>";
        //             //     return;
        //             // }

        //             if (!data.positions || Object.keys(data.positions).length === 0) {
        //                 document.querySelector(".position").innerHTML = "<p>No open positions.</p>";
        //                 return;
        //             }

        //             let html = "<table border='1|1'>";
        //             html += "<tr><th>Symbol</th><th>Size</th><th>Entry Price</th><th>Unrealised PnL</th><th>mark_price</th><th>margin</th><th>liquidation_price</th><th>leverage</th><th>last update</th></tr>";
        //             Object.entries(data.positions).forEach(entry => {
        //                 const pos = entry[1];
        //                 // console.log(pos)

        //                 const sym = pos.product_symbol;
        //                 let unrealized_pnl_pct_margin = "0.00";
        //                 if (pos.unrealized_pnl_pct_margin) { unrealized_pnl_pct_margin = pos.unrealized_pnl_pct_margin; };

        //                 const date = new Date(pos.updated_at);
        //                 const now = new Date();
        //                 const diffMs = now - date;
        //                 const diffSec = diffMs / 1000;
        //                 const diffMin = diffSec / 60;


        //                 const margin = pos.margin || 0; // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü 0 ‡¶Ø‡¶¶‡¶ø undefined/null ‡¶π‡ßü
        //                 let numStr = margin.toString();

        //                 // ‡¶¶‡¶∂‡¶Æ‡¶ø‡¶ï‡ßá‡¶∞ ‡¶™‡¶∞ 3rd ‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶ö‡ßá‡¶ï
        //                 let thirdDecimal = 0;
        //                 if (numStr.includes('.')) {
        //                     let decimalPart = numStr.split('.')[1];
        //                     thirdDecimal = decimalPart.length > 2 ? parseInt(decimalPart[2]) : 0; // 3rd ‡¶∏‡ßç‡¶•‡¶æ‡¶®
        //                 }

        //                 // 2 ‡¶¶‡¶∂‡¶Æ‡¶ø‡¶ï ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßá ‡¶ó‡ßã‡¶≤‡¶ï
        //                 let formattedMargin = margin;
        //                 if (thirdDecimal >= 5) {
        //                     formattedMargin = Math.round(margin * 100) / 100; // ‡¶ó‡ßã‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ
        //                 } else {
        //                     formattedMargin = Math.floor(margin * 100) / 100; // ‡¶ï‡¶æ‡¶ü‡¶æ
        //                 }
        //                 const update_margin = formattedMargin.toFixed(2);

        //                 // console.log("Margin:", margin, "3rd Decimal:", thirdDecimal, "Update Margin:", update_margin);




        //                 // let default_leverage = "";
        //                 // if (pos.product.default_leverage) {
        //                 //     default_leverage = pos.product.default_leverage;
        //                 // }

        //                 let default_leverage = 1.0; // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶´‡ßç‡¶≤‡ßã‡¶ü ‡¶Æ‡¶æ‡¶®
        //                 if (pos.product && pos.product.default_leverage) {
        //                     default_leverage = pos.product.default_leverage;
        //                 }


        //                 // console.log(date)
        //                 html += `<tr>
        //                 <td>${sym}</td>
        //                 <td>${pos.size}</td>
        //                 <td>${Number(pos.entry_price || 0).toFixed(8)}</td>
        //                 <td>${pos.unrealized_pnl}(${unrealized_pnl_pct_margin})</td>
        //                 <td>${pos.mark_price}</td>
        //                 <td>${update_margin}</td>
        //                 <td>${pos.liquidation_price}</td>
        //                 <td>${+default_leverage}x</td>
        //                 <td>${diffSec.toFixed(0)} sec ago (${diffMin.toFixed(1)} min ago)</td>
        //               </tr>
        //               </tr> <button class="btn-stoploss" data-sym="${sym}">Set Stop Loss</button>
        // <button class="btn-profit" data-sym="${encodeURIComponent(JSON.stringify(pos))}">Set Take Profit</button>
        // <button class="btn-close"  data-sym="${encodeURIComponent(JSON.stringify(pos))}">Close Trade</button>`;
        //             });
        //             html += "</table>";
        //             document.querySelector(".position").innerHTML = html;
        //         } catch (err) {
        //             console.log("Error fetching positions:", err);
        //         }
        //     }






        async function get_positions() {
            try {
                const res = await fetch("/v2/positions/margined?positions=true&user_id=" + userId + "&token=" + token);
                if (!res.ok) throw new Error("Unauthorized or fetch error");
                const data = await res.json();
                // console.log("Positions", data.positions);

                if (!data.positions || Object.keys(data.positions).length === 0) {
                    document.querySelector(".position").innerHTML = "<p>No open positions.</p>";
                    return;
                }

                // Check total number of positions
                const totalPositions = Object.keys(data.positions).length;
                // console.log("Total Positions:", totalPositions);

                let html = `<p>Total Positions: ${totalPositions}</p>`;

                // let html = "";
                Object.entries(data.positions).forEach(entry => {
                    const pos = entry[1];
                    // console.log("pos22 :", pos);
                    const sym = pos.product_symbol;
                    let unrealized_pnl_pct_margin = "0.00";
                    if (pos.unrealized_pnl_pct_margin) {
                        unrealized_pnl_pct_margin = pos.unrealized_pnl_pct_margin;
                    };

                    // const date = new Date(pos.updated_at);
                    // const now = new Date();
                    // const diffMs = now - date;
                    // const diffSec = diffMs / 1000;
                    // const diffMin = diffSec / 60;


                    // Set quantity or process positions
                    const date = new Date(pos.updated_at);
                    // Format date to "22 Oct 8:05:02 PM" style
                    const formattedDate = date.toLocaleString('en-US', {
                        day: '2-digit',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true,
                        timeZone: 'Asia/Kolkata' // IST
                    }).replace(/,/, ''); // Remove comma if present

                    const margin = pos.margin || 0;
                    let numStr = margin.toString();
                    let thirdDecimal = 0;
                    if (numStr.includes('.')) {
                        let decimalPart = numStr.split('.')[1];
                        thirdDecimal = decimalPart.length > 2 ? parseInt(decimalPart[2]) : 0;
                    }

                    let formattedMargin = margin;
                    if (thirdDecimal >= 5) {
                        formattedMargin = Math.round(margin * 100) / 100;
                    } else {
                        formattedMargin = Math.floor(margin * 100) / 100;
                    }
                    const update_margin = formattedMargin.toFixed(2);

                    let default_leverage = 1.0;
                    if (pos.product && pos.product.default_leverage) {
                        default_leverage = pos.product.default_leverage;
                    }

                    // Determine color based on unrealized_pnl
                    const pnlColor = pos.unrealized_pnl < 0 ? 'red' : 'green';
                    const buy_sell_color = pos.size < 0 ? 'red' : 'green';

                    // Create buttons above the table for each position
                    html += `
                    <div>
                    <button class="btn-stoploss" data-sym="${sym}">Set Stop Loss</button>
                    <button class="btn-profit" data-sym="${encodeURIComponent(JSON.stringify(pos))}">Set Take Profit</button>
                    <button class="btn-close" data-sym="${encodeURIComponent(JSON.stringify(pos))}">Close Trade</button>
                    <table border='1|1' style="border-collapse: collapse; border-left:6px solid ${buy_sell_color};" >
                        <tr><th>Symbol</th><th>Size</th><th>Entry Price</th><th>Unrealised PnL</th><th>mark_price</th><th>margin</th><th>liquidation_price</th><th>leverage</th><th>date</th></tr>
                        <tr style="color:blue;" >
                            <td>${sym}</td>
                            <td style="color: ${buy_sell_color};">${pos.size * pos.product?.contract_value}</td>
                            <td>${Number(pos.entry_price || 0).toFixed(8)}</td>
                            <td style="color: ${pnlColor};">${pos.unrealized_pnl}(${unrealized_pnl_pct_margin}%)</td>
                            <td>${pos.mark_price}</td>
                            <td>${update_margin}</td>
                            <td>${pos.liquidation_price}</td>
                            <td>${+default_leverage}x</td>
                            <td>${formattedDate}</td>
                        </tr>
                    </table>
                    </div> <br>
                    `;


                });
                document.querySelector(".position").innerHTML = html;
            } catch (err) {
                console.log("Error fetching positions:", err);
            }
        }
        /////////////////////////////////////////////////////////////



        // Flask endpoint ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶®‡¶¨‡ßá
        async function updateApiData() {
            if (!userId) return;
            const apiKeyText = document.getElementById('apiKeyText');
            const apiSecretText = document.getElementById('apiSecretText');

            const apiKeyText2 = document.getElementById('apiKeyText2');
            const apiSecretText2 = document.getElementById('apiSecretText2');
            try {
                const res = await fetch(`/get_user/${userId}`);
                if (!res.ok) {
                    console.warn("‚ö†Ô∏è Failed to fetch user data:", res.status);
                    return;
                }

                const data = await res.json();

                // ‡¶Ø‡¶¶‡¶ø database key ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶æ‡¶π‡¶≤‡ßá data.database ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡¶æ‡¶ì
                if (data.database) {
                    document.getElementById("user_id").textContent = userId;
                    document.getElementById("username").textContent = data.database.username || "N/A";
                    document.getElementById("email").textContent = data.database.email || "N/A";

                    // console.log("database", data.database.delta)
                    apiKeyText.value = data.database.delta.api_key || "no api";
                    apiSecretText.value = data.database.delta.api_secret || "no api secret";

                    apiKeyText2.value = data.database.dcx.api_key || "no api";
                    apiSecretText2.value = data.database.dcx.api_secret || "no api secret";
                }

            } catch (err) {
                console.error("‚ùå Error fetching user data:", err);
            }


        }

        // ‡¶™‡ßç‡¶∞‡¶§‡¶ø 5 ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞‡¶™‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßã
        // updateHeaderData();




        // APP_URL = location.host;

        async function updateData() {
            try {
                const res = await fetch("/data?token=" + token);
                if (!res.ok) throw new Error("Unauthorized or fetch error");
                const data = await res.json();
                document.getElementById("counter").textContent = data.counter;
                document.getElementById("time").textContent = data.last_update;
                document.getElementById("ip").textContent = data.public_ip;
                document.getElementById("status").textContent = data.status;
                document.getElementById("conn").textContent = data.connection;
            } catch (err) {
                console.error("Error fetching data:", err);
            }
        }

        // ===============================
        // FETCH FUTURES DATA (every 5s)
        // ===============================
        async function binance_funding_update() {
            try {

                // console.log("selected =", selected, typeof selected);

                // ‚úÖ object ‚Üí array
                const symbolsArray = selected && typeof selected === "object"
                    ? Object.values(selected)
                    : [];

                const cleanTickers = symbolsArray.filter(
                    s => typeof s === "string" && s.trim() !== ""
                );
                // const cleanTickers = selected.filter(
                //     s => typeof s === "string" && s.trim() !== ""
                // );

                const symbolsParam = JSON.stringify(cleanTickers);

                // console.log("symbolsParam :", symbolsParam)

                const url =
                    `/tickers?binance_funding=true&symbols=${encodeURIComponent(symbolsParam)}`;

                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                data = await res.json();

                binance_funding = data;

                // console.log("data :", data)

            } catch (err) {
                console.error("Error fetching futures:", err);
            }
        }




        async function get_futures() {
            try {
                const dcx_res = await fetch("/funding?token=" + token + "&funding_Dcx=true");
                if (!dcx_res.ok) throw new Error("DCX fetch error");
                funding_data_dcx = await dcx_res.json();

                const delta_res = await fetch("/funding?token=" + token + "&funding=true");
                if (!delta_res.ok) throw new Error("Delta fetch error");
                funding_data = await delta_res.json();



                localStorage.setItem("fundingDataDcx", JSON.stringify(funding_data_dcx));
                localStorage.setItem("fundingData", JSON.stringify(funding_data));

                // console.log("funding data updated:", funding_data);

            } catch (err) {
                console.error("Error fetching futures:", err);
            }
        }






        // async function get_futures() {
        // try {
        //     const brokerSelect = document.querySelector('#Brocker select');
        //     const option = brokerSelect.options[brokerSelect.selectedIndex];
        //     let data = "";
        //     let dcx_data = "";
        //     // if (option.value == "Dcx") {
        //     const res = await fetch(APP_URL + "/funding?token=" + token + "&funding_Dcx=true");
        //     if (!res.ok) throw new Error("Unauthorized or fetch error");
        //     data = await res.json();
        //     // } else {
        //     const dcx_res = await fetch(APP_URL + "/funding?token=" + token + "&funding=true");
        //     if (!dcx_res.ok) throw new Error("Unauthorized or fetch error");
        //     dcx_data = await dcx_res.json();
        //     // }


        //     // console.log(JSON.stringify(data))

        //     funding_data = data;
        //     funding_data_dcx = dcx_data;
        //     localStorage.setItem("fundingData", JSON.stringify(funding_data)); // save
        //     localStorage.setItem("fundingDataDcx", JSON.stringify(funding_data_dcx)); // save




        // ‚úÖ Step 1: Object -> Array (keep all fields)
        // const fundingArray = Object.entries(funding_data).map(([symbol, data]) => ({
        //     symbol,  // main key
        //     ...data, // merge all fields
        // }));

        // ‚úÖ Step 2: Sort by absolute funding_rate (descending)
        // fundingArray.sort((a, b) => Math.abs(b.funding_rate) - Math.abs(a.funding_rate));
        // console.log(fundingArray)



        // Populate dropdown only once (avoid duplicates)
        // if (dropdown.options.length <= 1) {
        //   for (const symbol of Object.keys(funding_data)) {
        //     const opt = document.createElement("option");
        //     opt.value = symbol;
        //     opt.textContent = symbol;
        //     dropdown.appendChild(opt);
        //   }
        // }
        //     } catch (err) {
        //         console.error("Error fetching futures:", err);
        //     }
        // }



        // ===============================
        // RENDER FUNDING DATA (every 1s)
        // ===============================
        // function renderFunding() {
        // //   fundingContainer.innerHTML = "";
        //   selected.forEach(sym => {
        //     const info = funding_data[sym];
        //     if (!info) return;

        //     const card = document.createElement("div");
        //     card.className = "funding-card";
        //     card.innerHTML = `
        //     <b>Symbol:</b> ${sym} <br>
        //     <b>Funding Rate:</b> ${info.funding_rate} <br>
        //     <b>Funding Rate (8h):</b> ${info.funding_rate_8h} <br>
        //     <b>Next Funding:</b> ${info.next_funding_in} <br>
        //     <b>Predicted Funding Rate:</b> ${info.predicted_funding_rate} <br>
        //     <b>Timestamp (IST):</b> ${info.timestamp_ist}
        //   `;
        //   console.log(card.innerHTML)
        //     // fundingContainer.appendChild(card);
        //   });
        // }


        // function saveSelected() {
        //   localStorage.setItem("selectedSymbols", JSON.stringify(selected));
        // }


        // Render funding data (show every 1 sec)
        //     function renderFunding(hh = false) {
        //         let selected = JSON.parse(localStorage.getItem("selectedSymbols")) || {};
        //         // console.log("üîÅ Current selectedSymbols:");

        //         // console.log("Funding value:", hh);

        //         Object.entries(selected).forEach(([id, sym]) => {
        //             // console.log(`${id} [${sym}]`);
        //             // console.log(funding_data[sym])
        //             const info = funding_data[sym];
        //             if (!info) return;

        //             const container = document.querySelector(`.contact_details-${id}`);
        //             const contactField = document.querySelector(`#contact-${id}`);

        //             // console.log(contactField.value)

        //             if (!container) return; // skip if element not found
        //             // else if (contactField.value == "M-f") return;
        //             else if (contactField.value != "" || hh == true) {


        //                 // console.log("value :",contactField.value)
        //                 container.innerHTML = ""; // clear previous content

        //                 const card = document.createElement("div");
        //                 card.className = "funding-card";
        //                 card.innerHTML = `
        //   <b>Symbol:</b> ${sym} <br>
        //   <b>Funding Rate:</b> ${info.funding_rate} <br>
        //   <div style="display:none"><b>Funding Rate (8h):</b> ${info.funding_rate_8h} <br></div>
        //   <b>Next Funding:</b> ${info.next_funding_in} <br>
        //   <b>Predicted Funding Rate:</b> ${info.predicted_funding_rate} <br>
        //   <b>Timestamp (IST):</b> ${info.timestamp_ist}
        // `;
        //                 container.appendChild(card);
        //             } else {
        //                 container.innerHTML = "";
        //             }


        //         });
        //     }

        // function showInlineError(input, message) {
        //     let err = input.nextElementSibling;

        //     if (!err || !err.classList.contains("error-msg")) {
        //         err = document.createElement("div");
        //         err.className = "error-msg";
        //         input.after(err);
        //     }

        //     err.textContent = message;


        // }

        // function clearInlineError(input) {
        //     const err = input.nextElementSibling;
        //     if (err && err.classList.contains("error-msg")) {
        //         err.remove();
        //     }
        // }


        ///////////////////////////////////////////////////////////////////////////
        function qs(sel, root = document) {
            return root.querySelector(sel);
        }

        function qsa(sel, root = document) {
            return [...root.querySelectorAll(sel)];
        }

        function toNum(v, d = 0) {
            const n = Number(v);
            return Number.isFinite(n) ? n : d;
        }



        /////////////////////////////////////////////////////////

        // clear all
        // function clearErrors() {
        //     document.querySelectorAll(".field").forEach(field => {
        //         field.style.marginBottom = "0px";

        //         const input = field.querySelector("input");
        //         input.classList.remove("error");

        //         // üîπ stored message remove
        //         delete input.dataset.errorMsg;

        //         field.querySelector(".error-msg").innerText = "";
        //     });
        // }






        function showInlineError(input, message) {
            let err = input.nextElementSibling;

            if (!err || !err.classList.contains("error-msg")) {
                err = document.createElement("div");
                err.className = "error-msg";
                input.after(err);
            }

            err.textContent = message;

            // force reflow to measure
            err.classList.add("show");

        }

        function clearInlineError(input) {
            const err = input.nextElementSibling;


            if (err && err.classList.contains("error-msg")) {
                // err.remove();
                err.classList.remove("show");

                // animate out then remove space
                setTimeout(() => {
                    err.remove();
                }, 200);
            } else {
                // field.style.setProperty("--err-space", "0px");
            }

        }






        // CORE LOGIC
        function applyRowSpacing(targetField) {
            const fields = [...document.querySelectorAll(".field")];
            const targetTop = targetField.getBoundingClientRect().top;

            fields.forEach(f => {
                const top = f.getBoundingClientRect().top;

                // tolerance for sub-pixel differences
                if (Math.abs(top - targetTop) < 6) {
                    f.style.marginBottom = "24px";
                }
            });
        }


        // function resetRowSpacing(targetField) {
        //     const fields = [...document.querySelectorAll(".field")];
        //     const targetTop = targetField.getBoundingClientRect().top;

        //     fields.forEach(f => {
        //         const top = f.getBoundingClientRect().top;

        //         // same row
        //         if (Math.abs(top - targetTop) < 6) {
        //             console.log("f :", f.style.marginBottom)
        //             f.style.marginBottom = "0px";
        //         }
        //     });
        // }


        function resetRowSpacing(targetField) {
            const fields = [...document.querySelectorAll(".field")];
            const targetTop = targetField.getBoundingClientRect().top;

            // üîç check: same row-‡¶§‡ßá ‡¶ï‡ßã‡¶®‡ßã error ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø ‡¶®‡¶æ
            let hasErrorInRow = false;

            fields.forEach(f => {
                const top = f.getBoundingClientRect().top;

                if (Math.abs(top - targetTop) < 6) {
                    const input = f.querySelector("input");
                    if (input && input.classList.contains("error")) {
                        hasErrorInRow = true;
                    }
                }
            });

            // ‚ùå ‡¶Ø‡¶¶‡¶ø error ‡¶è‡¶ñ‡¶®‡ßã ‡¶•‡¶æ‡¶ï‡ßá ‚Üí spacing ‡¶§‡ßÅ‡¶≤‡¶¨‡ßã ‡¶®‡¶æ
            if (hasErrorInRow) return;

            // ‚úÖ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá spacing remove
            fields.forEach(f => {
                const top = f.getBoundingClientRect().top;
                if (Math.abs(top - targetTop) < 6) {
                    f.style.marginBottom = "8px";
                }
            });
        }



        // re-calc on resize (VERY IMPORTANT)
        // window.addEventListener("resize", () => {
        //     const active = document.querySelector(".field input.error");

        //     if (active) {
        //         const msg = active.dataset.errorMsg; // üîπ original error
        //         // clearErrors();
        //         clearError(active)
        //         setError(active, msg);
        //     }
        // });


        function resetAllRowSpacing() {
            document.querySelectorAll(".field").forEach(f => {
                f.style.marginBottom = "0px";
            });
        }



        window.addEventListener("resize", () => {
            const activeErrors = document.querySelectorAll(".field input.error");

            if (!activeErrors.length) return;

            // üîπ STEP 1: ‡¶∏‡¶¨ stale margin clear
            resetAllRowSpacing();

            // üîπ STEP 2: ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶æ error input-‡¶è‡¶∞ row ‡¶Ü‡¶¨‡¶æ‡¶∞ apply
            activeErrors.forEach(input => {
                const msg = input.dataset.errorMsg;
                const field = input.closest(".field");

                // inline error ‡¶Ü‡¶¨‡¶æ‡¶∞ show (DOM safe)
                showInlineError(input, msg);

                applyRowSpacing(field);
            });
        });



        function setError(el, msg) {
            if (!el) return;
            el.classList.add("error");
            showInlineError(el, msg);

            // üîπ message store ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
            el.dataset.errorMsg = msg;

            let field = el.closest(".field");
            applyRowSpacing(field);
        }


        function clearError(el) {
            if (!el) return;

            el.classList.remove("error");
            delete el.dataset.errorMsg;

            clearInlineError(el);

            let field = el.closest(".field");
            resetRowSpacing(field);
        }




        // function clearError(el) {
        //     if (!el) return;
        //     el.classList.remove("error");
        //     // remove stored message
        //     delete el.dataset.errorMsg;

        //     // remove spacing from this row
        //     let field = el.closest(".field");
        //     resetRowSpacing(field);

        //     clearInlineError(el);
        // }

        function hasError(...els) {
            return els.some(el => el?.classList.contains("error"));
        }

        function getMaxLeverage(dynamic) {
            if (!dynamic || typeof dynamic !== "object") return null;
            const keys = Object.keys(dynamic).map(Number);
            return keys.length ? Math.max(...keys) : null;
        }

        function getMinQty(minNotional, price) {
            if (!price || price <= 0) return 0;
            return Math.ceil(minNotional / price);
        }



        ///////////////////////////////////////////////////////////////////////////

        function updateSelectedFromActiveLegs() {
            const selected = {};

            document.querySelectorAll('[id^="leg"]').forEach(leg => {
                const legId = leg.id.replace("leg", "");
                const contactField = leg.querySelector(`#contact-${legId}`);
                if (!contactField) return;

                const symbol = contactField.value?.trim();
                if (symbol) selected[legId] = symbol;
            });

            setSelected(selected)
            // localStorage.setItem("selectedSymbols", JSON.stringify(selected));
            console.log("‚úÖ Synced selectedSymbols:", selected);
        }

        function truncateStr(num, decimals = 5) {
            const [i, d = ""] = String(num).split(".");
            return Number(i + "." + d.slice(0, decimals));
        }


        function renderFunding(hh = false) {
            // console.log("Rendering funding data...");
            if (!rander_funding_condition) return;



            const brokerSelect = qs('#Brocker select');
            // const broker = brokerSelect?.value;





            const selected = JSON.parse(localStorage.getItem("selectedSymbols")) || {};

            // console.log(selected)

            Object.entries(selected).forEach(([id, sym]) => {

                let broker = qs(`select[name^="brocker_contact-${id}"]`)?.closest('.field')?.offsetParent
                    ? qs(`select[name^="brocker_contact-${id}"]`).selectedOptions[0].text
                    : brokerSelect?.value;

                // console.log("brocker :", broker);

                // console.log("data :", qs(`select[name^="brocker_contact-${id}"]`))
                // console.log("bbs :", bbs);



                // Brocker: leg.querySelector('select[name^="brocker_contact-"]')?.closest('.field')?.offsetParent
                //     ? leg.querySelector('select[name^="brocker_contact-"]').selectedOptions[0].text
                //     : null
                //     || option?.value,

                // console.log("id :", id)


                const info = broker?.toLowerCase() === "dcx"
                    ? funding_data_dcx?.[sym]
                    : funding_data?.[sym];

                //console.log("info :", info);

                // const ticker = broker?.toLowerCase() === "dcx"
                //     ? all_tickers_data_dcx?.[sym]
                //     : all_tickers_data?.[sym];

                // console.log(sym)
                // console.log(all_tickers_data_dcx?.[sym])


                const ticker =
                    broker?.toLowerCase() === "dcx"
                        ? all_tickers_data_dcx?.[sym]
                        : all_tickers_data?.[sym];

                // const ticker = all_tickers_data?.[sym];

                if (!ticker) return;

                // ---------------- DOM ----------------
                const leg = document.getElementById(`leg${id}`);

                // const container = leg.querySelector(`.contact_details-${id}`);
                const container = qs(`.contact_details-${id}`);

                const contactField = qs(`#contact-${id}`);
                const qtyInput = qs(`.qty-${id}`);
                const priceField = qs(`.price-${id}`);
                const leverageField = qs(`#Leverage-${id}`);
                const saveBtn = qs(`#save-btn-${id}`);

                const lPriceInput = qs(`input[type="number"][id^="l-price-${id}"]`);
                const currencyType = qs(`input[name="currency-type-${id}"]:checked`)?.value;
                const checkbox = qs(`input[id^="best-bid-toggle-${id}"]`);
                // console.log("checkbox :", checkbox?.checked);
                // checkbox?.checked = checkbox ? true : false;


                //////////////////////////////////////////////////////////////////
                // check only .............
                // const fields = {
                //     qtyInput,
                //     priceField,
                //     lPriceInput,
                //     leverageField,
                //     saveBtn,
                //     checkbox
                // };

                // const missing = Object.entries(fields)
                //     .filter(([_, el]) => !el)
                //     .map(([name]) => name);

                // if (missing.length) {
                //     console.warn(`‚ùå Missing fields inside leg${id}:`, missing);
                //     return;
                // }
                //////////////////////////////////////////////////////////////////


                if (!qtyInput || !priceField || !lPriceInput || !leverageField || !saveBtn || !checkbox) return;

                // console.log("container appr :", container);
                // console.log("priceField :",qtyInput);
                // console.log("priceField :",leverageField);

                // ---------------- VALUES ----------------
                const qty = toNum(qtyInput.value, 1);
                const leverage = toNum(leverageField.value, 1);
                const contractValue = toNum(ticker.contract_value, 1);

                const markPrice =
                    broker === "Dcx"
                        ? toNum(binance_funding?.[sym]?.mark_price)
                        : toNum(ticker.mark_price);

                // console.log("markPrice :", markPrice)

                // ---------------- AMOUNT ----------------
                const amount = (qty * contractValue * markPrice) / leverage;

                const rate =
                    currencyType === "INR"
                        ? broker === "Dcx" ? 96 : 85
                        : 1;

                priceField.value = formatPrice(
                    Number.isFinite(amount)
                        ? (amount * rate).toFixed(2)
                        : "0.00"
                );


                // ---------------- CHACKBOX VALIDATION  ----------------
                // console.log("checkbox checked :", checkbox.checked);
                // console.log(lPriceInput.innerText);
                if (checkbox.checked) {
                    // console.log("‚úÖ Checkbox is checked");
                    // Use Best Bid Price
                    // console.log("broker", broker)
                    if (broker == "Dcx") {
                        // console.log("Using DCX Best Bid Price");
                        const price = Number(info?.mark_price);
                        // console.log("price :", price);
                        if (Number.isFinite(price)) {
                            lPriceInput.value = formatPrice(price);
                        }
                    } else {
                        const bestBid = ticker?.quotes?.best_bid;
                        if (bestBid) {
                            lPriceInput.value = formatPrice(Number(bestBid));
                        }
                    }
                }

                // ---------------- PRICE VALIDATION ----------------
                if (!toNum(lPriceInput.value)) {
                    setError(lPriceInput, "Price is required");
                } else {
                    if (lPriceInput.value <= ticker?.price_band?.upper_limit) {
                        clearError(lPriceInput);
                    } else {
                        setError(lPriceInput, "Max Buy " + truncateStr(ticker?.price_band?.upper_limit, 5));
                    }
                    // console.log("ticker :", ticker?.price_band?.upper_limit);


                }





                // ---------------- DCX MIN NOTIONAL ----------------
                if (broker === "Dcx") {
                    const price = toNum(lPriceInput.value);
                    const minNotional = toNum(ticker.min_notional);
                    const minQty = getMinQty(minNotional, price);

                    if (price * qty < minNotional) {
                        setError(qtyInput, `Minimum Qty: ${minQty}`);
                    } else {
                        clearError(qtyInput);
                    }
                } else {
                    clearError(qtyInput);
                }

                // ---------------- BALANCE CHECK ----------------
                const usdBalance =
                    broker === "Dcx"
                        ? toNum(qs('#usd2')?.textContent)
                        : toNum(qs('#usd')?.textContent, 10);

                if (amount > usdBalance) {
                    setError(priceField, `Max Amount: ${formatPrice(usdBalance)}`);
                    // console.log(`Max Amount: ${formatPrice(usdBalance)}`)
                } else {
                    clearError(priceField);
                    // console.log("priceField :", priceField)
                }

                // ---------------- LEVERAGE LIMIT ----------------
                let maxLev = null;

                if (broker === "Dcx") {
                    maxLev = getMaxLeverage(ticker.dynamic_leverage);
                }

                const allowedLev = maxLev || ticker.leverage || 1;

                if (leverage > allowedLev) {
                    leverageField.value = allowedLev;
                    leverageField.setAttribute("max", allowedLev);
                }

                // ---------------- SAVE BUTTON ----------------
                const invalid = hasError(qtyInput, lPriceInput, priceField);
                saveBtn.disabled = invalid;
                saveBtn.style.opacity = invalid ? 0.5 : 1;

                // ---------------- CARD ----------------
                if (!container) return;
                container.innerHTML = "";

                if (!info) {
                    container.innerHTML = `<div class="funding-card empty">No data for ${sym}</div>`;
                    return;
                }

                if (contactField?.value || hh) {
                    const nextFunding =
                        broker === "Dcx"
                            ? binance_funding?.[sym]?.next_funding_time
                            : info.next_funding_in;

                    const funding_rate =
                        broker === "Dcx"
                            ? info.funding_rate
                            : Number(info.funding_rate).toFixed(6);

                    const predicted_funding_rate =
                        broker === "Dcx"
                            ? info.predicted_funding_rate
                            : Number(info.predicted_funding_rate).toFixed(6);

                    container.innerHTML = `
                <div class="funding-card">
                    <b>Symbol:</b> ${sym}<br>
                    <b>Price:</b> ${formatPrice(markPrice)}<br>
                    <b>Leverage:</b> ${allowedLev}x<br>
                    <b>Funding Rate:</b> ${funding_rate}<br>
                    <b>Next Funding:</b> ${nextFunding}<br>
                    <b>Predicted Funding:</b> ${predicted_funding_rate}<br>
                    <b>Time (IST):</b> ${info.timestamp_ist}
                </div>
            `;
                }
            });
        }




        function update_contact_details(id, text) {
            const container = document.querySelector(`.contact_details-${id}`);
            container.innerHTML = ""; // clear previous content
            const card = document.createElement("div");
            card.className = "funding-card";


            card.innerHTML = `
      <b>error:</b> ${text} <br>
    `;





            //         card.innerHTML = `
            //   <b>Symbol:</b> ${sym} <br>
            //   <b>Funding Rate:</b> ${info.funding_rate} <br>
            //   <div style="display:none"><b>Funding Rate (8h):</b> ${info.funding_rate_8h} <br></div>
            //   <b>Next Funding:</b> ${info.next_funding_in} <br>
            //   <b>Predicted Funding Rate:</b> ${info.predicted_funding_rate} <br>
            //   <b>Timestamp (IST):</b> ${info.timestamp_ist}
            // `;

            container.appendChild(card);
        }



        // function add_renderFunding(id, value) {
        //     if (value == "")
        //         return;
        //     let selected = getSelected(); // üî• always fresh
        //     if (value == "M-f") {

        //         const selected_v = document.querySelector(`input[name="f-r-p-${id}"]`);
        //         // const radios = document.querySelectorAll('input[name="f-r-p-1"]');
        //         // let contactField = document.querySelector(`#contact-${id}`);
        //         // console.log(selected_v.checked)
        //         if (selected_v.checked) {
        //             // console.log("‚úÖ Positive selected");
        //             const positives = Object.entries(funding_data)
        //                 .filter(([symbol, info]) => info.funding_rate > 0); // ‡¶∂‡ßÅ‡¶ß‡ßÅ positive ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∞‡¶æ‡¶ñ‡ßã

        //             let maxPositiveCoin = null;

        //             if (positives.length > 0) {
        //                 maxPositiveCoin = positives.reduce((max, [symbol, info]) => {
        //                     return info.funding_rate > max[1].funding_rate ? [symbol, info] : max;
        //                 });
        //             }

        //             if (maxPositiveCoin) {
        //                 // console.log("maxPositiveCoin :",maxPositiveCoin);
        //                 selected[id] = maxPositiveCoin[0];
        //                 localStorage.setItem("selectedSymbols", JSON.stringify(selected));
        //                 // setSelected()
        //                 renderFunding(true);
        //                 rander_funding_condition = true;

        //                 document.querySelector(`#contact-${id} option:nth-child(2)`).value = selected[id];
        //                 if (all_tickers_data[selected[id]].product_id) {
        //                     document.querySelector(`#contact-${id} option:nth-child(2)`).id = all_tickers_data[selected[id]].product_id;
        //                 }
        //             } else {
        //                 console.log("‚ùå No positive funding rate found");
        //                 update_contact_details(id, "‚ùå No positive funding rate found")
        //                 rander_funding_condition = false;
        //             }
        //             return;
        //         } else {
        //             // console.log("üîª Negative selected");
        //             const negatives = Object.entries(funding_data)
        //                 .filter(([symbol, info]) => info.funding_rate < 0); // ‡¶∂‡ßÅ‡¶ß‡ßÅ negative ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∞‡¶æ‡¶ñ‡ßã

        //             let maxNegativeCoin = null;

        //             if (negatives.length > 0) {
        //                 maxNegativeCoin = negatives.reduce((min, [symbol, info]) => {
        //                     return info.funding_rate < min[1].funding_rate ? [symbol, info] : min;
        //                 });
        //             }

        //             if (maxNegativeCoin) {
        //                 console.log(maxNegativeCoin);
        //                 selected[id] = maxNegativeCoin[0];
        //                 localStorage.setItem("selectedSymbols", JSON.stringify(selected));
        //                 renderFunding(true);
        //                 rander_funding_condition = true;
        //                 document.querySelector(`#contact-${id} option:nth-child(2)`).value = selected[id];
        //                 if (all_tickers_data[selected[id]].product_id) {
        //                     document.querySelector(`#contact-${id} option:nth-child(2)`).id = all_tickers_data[selected[id]].product_id;
        //                 }

        //             } else {
        //                 console.log("‚ùå No negative funding rate found");
        //                 update_contact_details(id, "‚ùå No negative funding rate found")
        //                 rander_funding_condition = false;
        //             }



        //             return;
        //         }
        //         // Find coin with highest absolute funding_rate
        //         // const maxCoin = Object.entries(funding_data).reduce((max, [symbol, info]) => {
        //         //     return Math.abs(info.funding_rate) > Math.abs(max[1].funding_rate)
        //         //         ? [symbol, info]
        //         //         : max;
        //         // });

        //         // console.log("üîπ Highest Absolute Funding Rate Coin:", maxCoin[0]);
        //         // console.log("üîπ Funding Rate:", maxCoin[1].funding_rate);
        //         // selected[id] = maxCoin[0];
        //         // localStorage.setItem("selectedSymbols", JSON.stringify(selected));

        //         return;
        //     } else {
        //         selected[id] = value;
        //         localStorage.setItem("selectedSymbols", JSON.stringify(selected));
        //         // console.log(`Saved: ${id} [${value}]`);
        //         // console.log(selected)
        //         rander_funding_condition = true;
        //     }
        // }

        // // Function: Remove particular ID
        // function remove_renderFunding(id) {
        //     // localStorage ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßã
        //     let selected = JSON.parse(localStorage.getItem("selectedSymbols")) || {};

        //     if (selected[id]) {
        //         console.log(`Removed: ${id} [${selected[id]}]`);
        //         delete selected[id]; // ‡¶ì‡¶á id ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßã
        //         localStorage.setItem("selectedSymbols", JSON.stringify(selected));
        //     } else {
        //         console.log(`ID ${id} not found!`);
        //     }

        //     // Debug log
        //     console.log("Current data:", selected);
        // }



        function add_renderFunding(id, value) {
            if (!value) return;

            let selected = getSelected(); // üî• always fresh

            if (value === "M-f") {
                const selected_v = document.querySelector(`input[name="f-r-p-${id}"]`);
                if (!selected_v) return;

                const entries = Object.entries(funding_data);

                const filtered = selected_v.checked
                    ? entries.filter(([_, i]) => i.funding_rate > 0)
                    : entries.filter(([_, i]) => i.funding_rate < 0);

                if (!filtered.length) {
                    update_contact_details(id, "‚ùå No funding found");
                    return;
                }

                const best = filtered.reduce((a, b) =>
                    Math.abs(b[1].funding_rate) > Math.abs(a[1].funding_rate) ? b : a
                );

                selected[id] = best[0];
                setSelected(selected);

                renderFunding(true);
                rander_funding_condition = true;

                const opt = document.querySelector(`#contact-${id} option:nth-child(2)`);
                if (opt) {
                    opt.value = best[0];
                    if (all_tickers_data[best[0]]?.product_id) {
                        opt.id = all_tickers_data[best[0]].product_id;
                    }
                }
                return;
            }

            // Normal select
            selected[id] = value;
            setSelected(selected);
            rander_funding_condition = true;
        }



        function remove_renderFunding(id) {
            let selected = getSelected();

            if (id in selected) {
                delete selected[id];
                setSelected(selected);
                console.log(`Removed leg ${id}`);
            }

            renderFunding(true); // üî• UI refresh
        }





        /////////////////////////////////
        document.getElementById('reloadBalanceBtn2').onclick = function () {
            const img = this.querySelector('img');
            img.style.transition = 'transform 0.6s cubic-bezier(.17,.67,.83,.67)';
            img.style.transform = 'rotate(360deg)';
            get_balance_dcx();
            setTimeout(() => {
                img.style.transform = '';
            }, 600);
        };

        document.getElementById('reloadBalanceBtn').onclick = function () {
            const img = this.querySelector('img');
            img.style.transition = 'transform 0.6s cubic-bezier(.17,.67,.83,.67)';
            img.style.transform = 'rotate(360deg)';
            get_balance();
            setTimeout(() => {
                img.style.transform = '';
            }, 600);
        };


        async function get_balance() {
            try {
                const res = await fetch("/v2/wallet/balances?token=" + token);
                if (!res.ok) throw new Error("Unauthorized or fetch error");
                const data = await res.json();

                // üîç Find USD & INR
                const usd = data.find(a => a.asset_symbol === "USD");
                // const inr = data.find(a => a.asset_symbol === "INR");

                document.getElementById("usd").textContent =
                    usd ? Number(usd.available_balance).toFixed(2) : "0";

                document.getElementById("inr").textContent =
                    usd ? Number(usd.available_balance_inr).toFixed(2) : "error";

                // console.log(data[0]);
                return usd ? Number(usd.available_balance).toFixed(2) : "0"

            } catch (err) {
                console.error("Error fetching data:", err);
                return "error"
            }
        }


        async function get_balance_dcx() {
            try {
                const res = await fetch("/v2/wallet/balances?token=" + token + "&DCX=true");
                if (!res.ok) throw new Error("Unauthorized or fetch error");
                const data = await res.json();
                // console.log("DCX", data);
                const inrBalance = data.find(w => w.currency === "INR")?.balance || 0;
                const inrBalance2 = data.find(w => w.currency_short_name === "INR")?.balance || 0;
                // console.log("inrBalance :", inrBalance2);
                document.getElementById("Dcx_fund").textContent = inrBalance.toFixed(2) + " INR";
                document.getElementById("usd2").textContent = +(inrBalance2 / 96).toFixed(2);
                document.getElementById("inr2").textContent = Number(inrBalance2).toFixed(2);

                return +(inrBalance2 / 96).toFixed(2);
            } catch (err) {
                console.error("Error fetching data:", err);
                return "error"
            }
        }

        /////////////////////////////////



        // updateData()
        // get_futures()
        // setInterval(updateData, 1000); // refresh every 1 sec
        // setInterval(get_futures, 1000);
        // setInterval(renderFunding, 1000)


        // intervals = [];
        // let isRunning = false;

        // === ‡¶∏‡¶¨ interval ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßã ===
        function startAllIntervals() {
            if (isRunning) return; console.log("‚ö†Ô∏è Intervals already running!");

            console.log("‚úÖ Starting all intervals...");
            isRunning = true;

            if (userId) {
                // intervals.push(setInterval(updateApiData, 5000));
                // intervals.push(setInterval(updateData, 1000));
                // intervals.push(setInterval(get_positions, 1000));

                intervals.push(setInterval(async () => { await get_positions(); }, 1000));
                intervals.push(setInterval(async () => { await updateData(); }, 1000));
                intervals.push(setInterval(async () => { await updateApiData(); }, 5000));
                intervals.push(setInterval(async () => { await binance_funding_update(); }, 1000));
                intervals.push(setInterval(async () => { await updateMarquee(); }, 1000));
                intervals.push(setInterval(async () => { await updata_tickers_dcx(); }, 1000));
                intervals.push(setInterval(async () => { await get_active_order(); }, 1000));
                intervals.push(setInterval(async () => { await get_futures(); }, 1000));
                intervals.push(setInterval(async () => { await updateStrategyStatus(); }, 5000));
                intervals.push(setInterval(async () => { await loadData(); }, 2000));
                intervals.push(setInterval(async () => { await renderFunding(); }, 1000));


                // intervals.push(setInterval(updateMarquee, 1000));
                // intervals.push(setInterval(binance_funding_update, 1000));
                // intervals.push(setInterval(get_active_order, 1000));
                // intervals.push(setInterval(get_futures, 1000));
                // intervals.push(setInterval(renderFunding, 1000));
                // intervals.push(setInterval(updateStrategyStatus, 5000));
                // intervals.push(setInterval(loadData, 2000));
            }
        }

        // === ‡¶∏‡¶¨ interval ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßã ===
        function stopAllIntervals() {
            console.log("üõë Stopping all intervals...");
            isRunning = false;

            intervals.forEach(id => clearInterval(id)); // ‡¶∏‡¶¨ clear
            intervals = []; // ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶ï‡¶∞‡ßá ‡¶¶‡¶æ‡¶ì
        }




        ////////////////////////////////////////////////////////////
        //document actions...

        document.addEventListener("click", async (e) => {
            if (e.target.classList.contains("btn-stoploss")) {
                const data = e.target.dataset.sym;
                const posData = JSON.parse(decodeURIComponent(data));
                const price = prompt(`Enter stop loss price for ${posData.product_symbol}:`);
                if (price) await setStopLoss(posData, price);
            }
            else if (e.target.classList.contains("btn-profit")) {
                const data = e.target.dataset.sym;
                const posData = JSON.parse(decodeURIComponent(data));
                const price = prompt(`Enter take profit price for ${posData.product_symbol}:`);
                if (price) await setTakeProfit(posData, price);
            }
            else if (e.target.classList.contains("btn-close")) {


                const data = e.target.dataset.sym;

                // JSON.parse ‡¶ï‡¶∞‡ßá object ‡¶¨‡¶æ‡¶®‡¶æ‡¶®‡ßã
                const posData = JSON.parse(decodeURIComponent(data));

                // const confirmClose = confirm(`Are you sure to close ${posData.product_symbol}?`);
                // if (confirmClose) await closeTrade(posData);
                if (posData) await closeTrade_popup(posData);
            }
        });



        //set action stoploss,close,take profit

        async function setStopLoss(symbol, price) {
            console.log(`Setting stop loss for ${symbol} at ${price}`);
            // await fetch(`/api/set_stoploss`, {
            //     method: "POST",
            //     headers: { "Content-Type": "application/json" },
            //     body: JSON.stringify({ symbol, price })
            // });
        }

        async function setTakeProfit(symbol, price) {
            console.log(`Setting take profit for ${symbol} at ${price}`);
            // await fetch(`/api/set_takeprofit`, {
            //     method: "POST",
            //     headers: { "Content-Type": "application/json" },
            //     body: JSON.stringify({ symbol, price })
            // });
        }


        // async function closeTrade(data) {
        //     // console.log(this);
        //     console.log("Closing position:", data);

        //     // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá Delta API call ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßã

        //     const body = {
        //         product_id: data.product_id.toString(),
        //         size: Math.abs(data.size),
        //         side: data.size < 0 ? "buy" : "sell",
        //         order_type: "market_order",
        //         reduce_only: true
        //     };
        //     console.log(body)

        //     // const timestamp = String(Math.floor(Date.now() / 1000));
        //     // const signaturePayload = "POST" + timestamp + "/v2/orders" + JSON.stringify(body);
        //     // const signature = await generateSignature(signaturePayload); // Implement this function

        //     // await get_api_data("/v2/orders", body, "POST");
        //     const res = await fetch(APP_URL + "/v2/orders", {
        //         method: "POST",
        //         headers: {
        //             "Content-Type": "application/json"  // ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
        //         },
        //         body: JSON.stringify(body) // body ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á string ‡¶Ü‡¶ï‡¶æ‡¶∞‡ßá
        //     });
        //     if (!res.ok) throw new Error("Unauthorized or fetch error");
        //     const result = await res.json();
        //     console.log(result);


        //     if (result) {
        //         console.log("‚úÖ Closed:", data.product_symbol, result)
        //         await get_positions();
        //     }
        //     else
        //         console.log("‚ö†Ô∏è Failed to close:", data.product_symbol)

        // }




    </script>

    <script>
        async function checkServer() {
            const serverUrl = "http://127.0.0.1:5000/ping"; // ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ Flask server IP

            try {
                const controller = new AbortController();
                const signal = controller.signal;
                const timeout = setTimeout(() => controller.abort(), 5000); // 5 sec timeout

                const response = await fetch("/ping", { signal });


                clearTimeout(timeout);

                // console.log("response : ", response)

                if (response.ok) {
                    // console.log("‚úÖ Flask server is active!");
                    return true;
                } else {
                    console.log("‚ö†Ô∏è Flask server responded, but status not OK:", response.status);
                    return false;
                }

            }
            // catch (error) {
            //     console.log("‚ùå Flask server not active:", error.message);
            //     return false;
            // }

            catch (error) {
                if (error.name === "AbortError") {
                    console.log("‚è≥ Ping timeout (server busy)");
                    return true; // server alive but busy
                }
                console.log("‚ùå Flask server not active:", error.message);
                return false;
            }

        }

        // Example usage:
        async function checkServerStatus() {
            const isActive = await checkServer();
            if (isActive) {
                startAllIntervals();
                return;
            } else {
                // console.clear();
                stopAllIntervals();
            }
            console.log("Server Active:", isActive);
        }



        // Run immediately once
        checkServerStatus();

        // Then run every 10 seconds
        setInterval(checkServerStatus, 10000);

    </script>





    <script>
        let popupInterval = null; // global variable for interval ID
        const modal = document.getElementById('closePositionModal');
        const modalContentArea = document.getElementById('modalContentArea');

        // // Function to close the modal
        window.closeModal = function () {
            modal.style.display = 'none';
            modalContentArea.innerHTML = ''; // Clear content when closing

            // üõë Stop the interval when modal closes
            if (popupInterval) {
                clearInterval(popupInterval);
                popupInterval = null;
                console.log("Popup interval stopped.");
            }
        };



        async function closeTrade_popup(popdata) {
            // alert("click")
            // 1. Fetch the content of the popup.html file
            fetch('./static/pop.html')
                .then(response => {
                    if (!response.ok) throw new Error('Failed to load popup.html');
                    return response.text();
                    // console.log(response)
                })
                .then(html => {
                    // 2. Inject the fetched HTML into the modal content area
                    modalContentArea.innerHTML = html;
                    // 3. Show the modal (THIS WAS MISSING)
                    modal.style.display = 'flex';

                    // 3. Re-run scripts (optional, often necessary for event listeners)
                    const scripts = modalContentArea.querySelectorAll('script');
                    scripts.forEach(script => {
                        const newScript = document.createElement('script');
                        newScript.textContent = script.textContent;
                        modalContentArea.appendChild(newScript);
                    });

                    // üîπ Dispatch a custom event so pop.html script can use the data
                    const event = new CustomEvent('popupDataReady', { detail: popdata });
                    document.dispatchEvent(event);

                    // üîÅ Start interval here
                    popupInterval = setInterval(async () => {
                        console.log("Popup running...");
                        // ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá popup update ‡¶¨‡¶æ data check ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßã

                        try {
                            const res = await fetch("/v2/positions/margined?positions=true&token=" + token + "&user_id=" + userId);
                            if (!res.ok) throw new Error("Unauthorized or fetch error");
                            const data = await res.json();

                            if (!data.positions || Object.keys(data.positions).length === 0) {
                                // document.querySelector(".position").innerHTML = "<p>No open positions.</p>";
                                return;
                            }

                            // const popup_symbol = popdata.positions.product_symbol;
                            // console.log(popdata.product_symbol)
                            // console.log(data.positions[popdata.product_symbol])

                            document.dispatchEvent(new CustomEvent("popupDataupdate", { detail: data.positions[popdata.product_symbol] }));


                        } catch (error) {
                            console.error("Error fetching positions:", error);
                        }

                    }, 1000);
                })
                .catch(error => {
                    console.error('Error loading modal content:', error);
                    alert('Could not load the popup content.');
                });
        };

        // Close modal when clicking outside of the content (on the overlay)
        modal.addEventListener('click', function (e) {
            if (e.target.classList.contains('modal-overlay')) {
                window.closeModal();
            }
        });

    </script>


    <script>
        const editBtn = document.getElementById('editBtn');
        const editBtn2 = document.getElementById('editBtn2');

        const editSecretBtn = document.getElementById('editSecretBtn');
        const editSecretBtn2 = document.getElementById('editSecretBtn2');

        const toggleSecret = document.getElementById('toggleSecret');
        const toggleSecret2 = document.getElementById('toggleSecret2');

        const displayMode = document.getElementById('displayMode');
        const displayMode2 = document.getElementById('displayMode2');

        const editMode = document.getElementById('editMode');
        const editMode2 = document.getElementById('editMode2');

        const apiKeyText = document.getElementById('apiKeyText');
        const apiKeyText2 = document.getElementById('apiKeyText2');

        const apiSecretText = document.getElementById('apiSecretText');
        const apiSecretText2 = document.getElementById('apiSecretText2');

        const apiKeyInput = document.getElementById('apiKeyInput');
        const apiKeyInput2 = document.getElementById('apiKeyInput2');

        const apiSecretInput = document.getElementById('apiSecretInput');
        const apiSecretInput2 = document.getElementById('apiSecretInput2');

        const saveBtn = document.getElementById('saveBtn');
        const saveBtn2 = document.getElementById('saveBtn2');

        const cancelBtn = document.getElementById('cancelBtn');
        const cancelBtn2 = document.getElementById('cancelBtn2');

        let secretVisible = false;
        let secretVisible2 = false;

        // Toggle secret visibility
        toggleSecret.onclick = () => {
            secretVisible = !secretVisible;
            // apiSecretText.textContent = secretVisible ? (apiSecretInput.value || 'my-secret-key-98765') : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            apiSecretText.type = secretVisible ? "text" : "password";
            toggleSecret.textContent = secretVisible ? 'Hide' : 'Show';
        };

        toggleSecret2.onclick = () => {
            secretVisible2 = !secretVisible2;
            // apiSecretText.textContent = secretVisible ? (apiSecretInput.value || 'my-secret-key-98765') : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            apiSecretText2.type = secretVisible2 ? "text" : "password";
            toggleSecret2.textContent = secretVisible2 ? 'Hide' : 'Show';
        };


        // Enter edit mode
        editBtn.onclick = editSecretBtn.onclick = () => {
            displayMode.style.display = 'none';
            editMode.style.display = 'block';
            apiKeyInput.value = apiKeyText.value;
            apiSecretInput.value = apiSecretText.value;
        };
        editBtn2.onclick = editSecretBtn2.onclick = () => {
            displayMode2.style.display = 'none';
            editMode2.style.display = 'block';
            apiKeyInput2.value = apiKeyText2.value;
            apiSecretInput2.value = apiSecretText2.value;
        };

        // Save and switch back
        // saveBtn.onclick = () => {
        //     apiKeyText.textContent = apiKeyInput.value || 'your-api-key-example-12345';
        //     apiSecretText.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        //     displayMode.style.display = 'block';
        //     editMode.style.display = 'none';
        // };

        saveBtn.onclick = async () => {
            const apiKey = apiKeyInput.value.trim();
            const apiSecret = apiSecretInput.value.trim();
            // const userId = 1; // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ID ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶∏‡¶æ‡¶®

            if (!apiKey || !apiSecret) {
                notify("e", "Please fill both fields!");
                return;
            }

            const statusBox = document.getElementById("apiStatus");
            statusBox.style.display = "block";
            statusBox.style.background = "#f1f5f9";
            statusBox.innerHTML = "‚è≥ Checking API credentials...";

            const payload = {
                user_id: userId ? userId : 1,
                delta: {
                    api_key: apiKey,
                    api_secret: apiSecret
                }
            };

            try {
                const res = await fetch("/save_api_delta", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                console.log("Server response:", data);

                // if (data.success) {
                //     notify("s", "API saved successfully!");
                // } else {
                //     notify("e", "Failed to save: " + (data.msg || "unknown error"));
                // }

                if (data.success) {
                    statusBox.style.background = "#ecfeff";
                    statusBox.innerHTML = `
                ‚úÖ <b>Checking Successful</b><br>
                üîê Account Type:
                <b style="color:${data.account_type === "LIVE" ? "#16a34a" : "#2563eb"}">
                    ${data.account_type}
                </b>
            `;

                    apiKeyText.value = apiKey;
                    apiSecretText.value = apiSecret;
                    apiSecretText.type = "password";

                    displayMode.style.display = 'block';
                    editMode.style.display = 'none';

                    notify("s", "API saved successfully!");

                } else {
                    statusBox.style.background = "#fee2e2";
                    statusBox.innerHTML = `‚ùå ${data.msg}`;
                }

            } catch (err) {
                console.error("Error:", err);
                notify("e", "Error connecting to server!");
                notify("e", "Failed to save: " + (data.msg || "unknown error"));
                statusBox.style.background = "#fee2e2";
                statusBox.innerHTML = "‚ùå Server error while checking API";
            }
        };


        saveBtn2.onclick = async () => {
            const apiKey = apiKeyInput2.value.trim();
            const apiSecret = apiSecretInput2.value.trim();
            // const userId = 1; // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ID ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶∏‡¶æ‡¶®

            if (!apiKey || !apiSecret) {
                notify("e", "Please fill both fields!");
                return;
            }

            const statusBox = document.getElementById("apiStatus2");
            statusBox.style.display = "block";
            statusBox.style.background = "#f1f5f9";
            statusBox.innerHTML = "‚è≥ Checking API credentials...";

            const payload = {
                user_id: userId ? userId : 1,
                delta: {
                    api_key: apiKey,
                    api_secret: apiSecret
                }
            };

            try {
                const res = await fetch("/save_api_dcx", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                console.log("Server response:", data);

                // if (data.success) {
                //     notify("s", "API saved successfully!");
                // } else {
                //     notify("e", "Failed to save: " + (data.msg || "unknown error"));
                // }

                if (data.success) {
                    statusBox.style.background = "#ecfeff";
                    statusBox.innerHTML = `
                ‚úÖ <b>Checking Successful</b>
            `;

                    apiKeyText2.value = apiKey;
                    apiSecretText2.value = apiSecret;
                    apiSecretText2.type = "password";

                    displayMode2.style.display = 'block';
                    editMode2.style.display = 'none';

                    notify("s", "API saved successfully!");

                } else {
                    statusBox.style.background = "#fee2e2";
                    statusBox.innerHTML = `‚ùå ${data.msg}`;
                }

            } catch (err) {
                console.error("Error:", err);
                notify("e", "Error connecting to server!");
                notify("e", "Failed to save: " + (data.msg || "unknown error"));
                statusBox.style.background = "#fee2e2";
                statusBox.innerHTML = "‚ùå Server error while checking API";
            }
        };

        // Cancel edit
        cancelBtn.onclick = () => {
            displayMode.style.display = 'block';
            editMode.style.display = 'none';
        };
        cancelBtn2.onclick = () => {
            displayMode2.style.display = 'block';
            editMode2.style.display = 'none';
        };
    </script>


    <!-- ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ page content -->

    <script>
        console.log(`Rendered at: {{ time.time() }}`);
    </script>




</body>

</html>